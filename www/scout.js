"use strict"

addI18n({
	choose_pos_heading:{
		en:'Pick your field orientation and robot position',
		pt:'Escolha a orientação do seu campo e a posição do robô',
		fr:'Choisissez l\'orientation du terrain et la position du robot',
		zh_tw:'選擇場地方向和機器人位置',
		he:'בחר את כיוון השדה ואת עמדת הרובוט שלך',
		tr:'Alan yönünüzü ve robot pozisyonunuzu seçin',
	},
	choose_pos_or:{
		en:'OR',
		pt:'ou',
		fr:'ou',
		zh_tw:'或者',
		he:'אוֹ',
		tr:'veya',
	},
	pre_match_tab:{
		en:'Pre',
		pt:'Pré',
		fr:'Pré',
		zh_tw:'預',
		he:'מִרֹאשׁ',
		tr:'Ön',
	},
	auto_tab:{
		en:'Auto',
		pt:'Auto',
		fr:'Auto',
		zh_tw:'汽車',
		he:'אוטומטי',
		tr:'Otomatik',
	},
	tele_tab:{
		en:'Tele',
		pt:'Tele',
		fr:'Télé',
		zh_tw:'遠距離',
		he:'טל',
		tr:'Tele',
	},
	end_game_tab:{
		en:'End',
		pt:'Fim',
		fr:'Fin',
		zh_tw:'結尾',
		he:'סוֹף',
		tr:'Bitiş',
	},
	red:{
		en:'red',
		pt:'vermelho',
		fr:'rouge',
		zh_tw:'紅色的',
		he:'אָדוֹם',
		tr:'kırmızı',
	},
	blue:{
		en:'blue',
		pt:'azul',
		fr:'bleu',
		zh_tw:'藍色的',
		he:'כְּחוֹל',
		tr:'mavi',
	},
	team_correction_button:{
		en:'Team # Correction',
		pt:'Correção do número da equipe',
		fr:'Correction du numéro d\'équipe',
		zh_tw:'團隊 # 修正',
		he:'צוות # תיקון',
		tr:'Takım # Düzeltme',
	},
	choose_match_button:{
		en:'Choose Match',
		pt:'Escolher partida',
		fr:'Choisir une partie',
		zh_tw:'選擇匹配',
		he:'בחר התאמה',
		tr:'Maç Seç',
	},
	rotate_field_button:{
		en:'Rotate Field',
		pt:'Girar campo',
		fr:'Pivoter le terrain',
		zh_tw:'旋轉字段',
		he:'סובב שדה',
		tr:'Alanı Döndür',
	},
	change_robot_button:{
		en:'Change Robot',
		pt:'Alterar robô',
		fr:'Changer de robot',
		zh_tw:'更換機器人',
		he:'שנה רובוט',
		tr:'Robotu Değiştir',
	},
	save_button:{
		en:'Save',
		pt:'Salvar',
		fr:'Enregistrer',
		zh_tw:'節省',
		he:'לְהַצִיל',
		tr:'Kaydet',
	},
	no_show:{
		en:'No Show',
		pt:'Não aparecer',
		fr:'Non présent',
		zh_tw:'沒有出席',
		he:'אין הופעה',
		tr:'Gösterilmedi',
	},
	proceed_auto_button:{
		en:'Auto »',
		pt:'Auto »',
		fr:'Auto »',
		zh_tw:'汽車 ”',
		he:'אוטומטי »',
		tr:'Otomatik »',
	},
	proceed_tele_button:{
		en:'Teleop »',
		pt:'Teleop »',
		fr:'Télé »',
		zh_tw:'遠端操作 »',
		he:'טלאופ »',
		tr:'Teleop »',
	},
	proceed_end_button:{
		en:'End Game »',
		pt:'Fim do jogo »',
		fr:'Fin de partie »',
		zh_tw:'結束遊戲 »',
		he:'משחק סיום »',
		tr:'Oyunu Sonlandır »',
	},
	scouting_title:{
		en:'_TEAMNUM_ _POS_ _MATCHSHORT_ _EVENTNAME_',
		pt:'_TEAMNUM_ _POS_ _MATCHSHORT_ _EVENTNAME_',
		fr:'_TEAMNUM_ _POS_ _MATCHSHORT_ _EVENTNAME_',
		zh_tw:'_TEAMNUM_ _POS_ _MATCHSHORT_ _EVENTNAME_',
		he:'_TEAMNUM_ _POS_ _MATCHSHORT_ _EVENTNAME_',
		tr:'_TEAMNUM_ _POS_ _MATCHSHORT_ _EVENTNAME_',
	},
	scouting_heading:{
		en:'_EVENTNAME_, _POS_, _MATCHNAME_, Team _TEAMNUM_',
		pt:'_EVENTNAME_, _POS_, _MATCHNAME_, Equipe _TEAMNUM_',
		fr:'_EVENTNAME_, _POS_, _MATCHNAME_, Équipe _TEAMNUM_',
		zh_tw:'_EVENTNAME_、_POS_、_MATCHNAME_、隊伍 _TEAMNUM_',
		he:'_EVENTNAME_, _POS_, _MATCHNAME_, צוות _TEAMNUM_',
		tr:'_EVENTNAME_, _POS_, _MATCHNAME_, Takım _TEAMNUM_',
	},
	pit_scouting_title:{
		en:'_TEAMNUM_ Pit Scouting at _EVENTNAME_',
		pt:'_TEAMNUM_ Pit Scouting em _EVENTNAME_',
		fr:'_TEAMNUM_ Reconnaissance des stands à _EVENTNAME_',
		zh_tw:'_TEAMNUM_ 在 _EVENTNAME_ 進行維修站偵察',
		he:'_TEAMNUM_ צופי בורות ב-_EVENTNAME_',
		tr:'_TEAMNUM_ _EVENTNAME_\'de Pit Scout',
	},
	pit_scouting_heading:{
		en:'Pit Scout _TEAMNUM_ at _EVENTNAME_',
		pt:'Pit Scout _TEAMNUM_ em _EVENTNAME_',
		fr:'Reconnaissance des stands _TEAMNUM_ à _EVENTNAME_',
		zh_tw:'_EVENTNAME_ 的維修站偵察兵 _TEAMNUM_',
		he:'Pit Scout _TEAMNUM_ ב-_EVENTNAME_',
		tr:'_TEAMNUM_ _EVENTNAME_\'de Pit Scout',
	},
	select_pos_title:{
		en:'Choose _EVENTNAME_ bot',
		pt:'Escolha o bot _EVENTNAME_',
		fr:'Choisir le robot _EVENTNAME_',
		zh_tw:'選擇 _EVENTNAME_ 機器人',
		he:'בחר בוט _EVENTNAME_',
		tr:'_EVENTNAME_ botunu seçin',
	},
	select_pos_heading:{
		en:'_EVENTNAME_',
		pt:'_EVENTNAME_',
		fr:'_EVENTNAME_',
		zh_tw:'_事件名稱_',
		he:'_EVENTNAME_',
		tr:'_EVENTNAME_',
	},
	team_correction_title:{
		en:'_EVENTNAME_, _POS_, _MATCHNAME_,',
		pt:'_EVENTNAME_, _POS_, _MATCHNAME_,',
		fr:'_EVENTNAME_, _POS_, _MATCHNAME_,',
		zh_tw:'_EVENTNAME_, _POS_, _MATCHNAME_,',
		he:'_EVENTNAME_, _POS_, _MATCHNAME_,',
		tr:'_EVENTNAME_, _POS_, _MATCHNAME_,',
	},
	team_correction_heading:{
		en:'_MATCHNAME_ _POS_ Team Number Correction',
		pt:'_MATCHNAME_ _POS_ Correção do número da equipe',
		fr:'_MATCHNAME_ _POS_ Correction du numéro d\'équipe',
		zh_tw:'_MATCHNAME_ _POS_ 隊伍號碼修正',
		he:'_MATCHNAME_ _POS_ תיקון מספר צוות',
		tr:'_MATCHNAME_ _POS_ Takım Numarası Düzeltme',
	},
	pit_scouting_select_team_title:{
		en:'Pit Scout at _EVENTNAME_',
		pt:'Pit Scout em _EVENTNAME_',
		fr:'Reconnaissance des stands à _EVENTNAME_',
		zh_tw:'_EVENTNAME_ 的坑道偵察員',
		he:'פיט סקאוט ב-_EVENTNAME_',
		tr:'_EVENTNAME_\'de Pit Scout',
	},
	pit_scouting_select_team_heading:{
		en:'Select a Team to Pit Scout',
		pt:'Selecione uma equipe para fazer o Pit Scout',
		fr:'Sélectionner une équipe à repérer',
		zh_tw:'選擇一隊進行坑探',
		he:'בחר צוות ל-Pit Scout',
		tr:'Bir Takım Seç Pit Scout\'a',
	},
	subjective_scouting_select_team_title:{
		en:'Subjective Scout at _EVENTNAME_',
		pt:'Scout subjetivo em _EVENTNAME_',
		fr:'Reconnaissance subjective à _EVENTNAME_',
		zh_tw:'_EVENTNAME_ 的主觀偵察員',
		he:'צופית סובייקטיבית ב-_EVENTNAME_',
		tr:'_EVENTNAME_ adresindeki Öznel Scout',
	},
	subjective_scouting_select_team_heading:{
		en:'Select a Team to Subjectively Scout',
		pt:'Selecione uma equipe para fazer o Scout subjetivo',
		fr:'Sélectionner une équipe Scouting subjectif',
		zh_tw:'選擇一支球隊進行主觀考察',
		he:'בחר צוות לצפייה סובייקטיבית',
		tr:'Öznel Olarak Scout Yapmak İçin Bir Takım Seçin',
	},
	event_not_found:{
		en:'Event Not Found',
		pt:'Evento não encontrado',
		fr:'Événement introuvable',
		zh_tw:'未找到事件',
		he:'האירוע לא נמצא',
		tr:'Etkinlik Bulunamadı',
	},
	confirm_save_data_question:{
		en:'Do you want to save your data?',
		pt:'Você quer salvar seus dados?',
		fr:'Voulez-vous sauvegarder vos données ?',
		zh_tw:'您想保存您的資料嗎？',
		he:'האם אתה רוצה לשמור את הנתונים שלך?',
		tr:'Verilerinizi kaydetmek ister misiniz?',
	},
	done_scouting:{
		en:'Data saved and done. That was the last match!',
		pt:'Dados salvos e prontos. Essa foi a última partida!',
		fr:'Données sauvegardées et terminées. C\'était le dernier match !',
		zh_tw:'資料已儲存並完成。那是最後一場比賽！',
		he:'הנתונים נשמרו ובוצעו. זה היה המשחק האחרון!',
		tr:'Veriler kaydedildi ve tamamlandı. Bu son maçtı!',
	},
	undo_button:{
		en:'Undo',
		pt:'Desfazer',
		fr:'Annuler',
		zh_tw:'撤銷',
		he:'לְבַטֵל',
		tr:'Geri al',
	},
	pos_team:{
		en:'_POS_ _TEAMNUM_',
		pt:'_POS_ _TEAMNUM_',
		fr:'_POS_ _TEAMNUM_',
		zh_tw:'_位置_ _球隊號碼_',
		he:'_POS_ _TEAMNUM_',
		tr:'_POS_ _TEAMNUM_',
	},
	values_button:{
		en:'Values',
		pt:'Valores',
		fr:'Valeurs',
		zh_tw:'價值觀',
		he:'ערכים',
		tr:'Değerler',
	},
	timeline_button:{
		en:'Timeline',
		pt:'Linha do tempo',
		fr:'Chronologie',
		zh_tw:'時間軸',
		he:'ציר זמן',
		tr:'Zaman Çizelgesi',
	},
	timeline_time_header:{
		en:'Time',
		pt:'Hora',
		fr:'Heure',
		zh_tw:'時間',
		he:'זְמַן',
		tr:'Zaman',
	},
	timeline_action_header:{
		en:'Action',
		pt:'Ação',
		fr:'Action',
		zh_tw:'行動',
		he:'פְּעוּלָה',
		tr:'Eylem',
	},
	scouter_header:{
		en:'Scouter Info',
		pt:'Informações do Scouter',
		fr:'Informations sur le recruteur',
		zh_tw:'球探資訊',
		he:'מידע על צופי',
		tr:'Scouter Bilgileri',
	},
	scouter_name_question:{
		en:'Name:',
		pt:'Nome:',
		fr:'Nom :',
		zh_tw:'姓名：',
		he:'שֵׁם:',
		tr:'Ad:',
	},
	scouter_name_placeholder:{
		en:'Scouter Team, First name, Last initial, Eg. 1234 Pat Q',
		pt:'Equipe do Scouter, Primeiro nome, Inicial do último, Ex.: 1234 Pat Q',
		fr:'Équipe du recruteur, Prénom, Initiale du nom, ex.: 1234 Pat Q',
		zh_tw:'童子軍隊伍，名字，姓氏首字母，例如。 1234 還',
		he:'צוות צופים, שם פרטי, ראשי תיבות אחרון, למשל. 1234 Pat Q',
		tr:'Scouter Takımı, Adı, Soyadı, Örn. 1234 Pat Q',
	},
	comments_question:{
		en:'Comments:',
		pt:'Comentários:',
		fr:'Commentaires :',
		zh_tw:'評論：',
		he:'הערות:',
		tr:'Yorumlar:',
	},
	comments_placeholder:{
		en:'Comments',
		pt:'Comentários',
		fr:'Commentaires',
		zh_tw:'評論',
		he:'הערות',
		tr:'Yorumlar',
	},
	save_data_question:{
		en:'Save data:',
		pt:'Salvar dados:',
		fr:'Sauvegarder les données :',
		zh_tw:'儲存資料：',
		he:'שמור נתונים:',
		tr:'Verileri kaydet:',
	},
	next_match_button:{
		en:'Next Match',
		pt:'Próxima partida',
		fr:'Prochain match',
		zh_tw:'下一場比賽',
		he:'המשחק הבא',
		tr:'Sonraki Maç',
	},
	upload_data_button:{
		en:'Upload Data',
		pt:'Carregar dados',
		fr:'Télécharger les données',
		zh_tw:'上傳數據',
		he:'העלה נתונים',
		tr:'Verileri Yükle',
	},
	qr_code_button:{
		en:'QR Code',
		pt:'Código QR',
		fr:'Code QR',
		zh_tw:'QR 圖碼',
		he:'קוד QR',
		tr:'QR Kodu',
	},
})

var pos = "",
team = "",
match = "",
orient = localStorage.getItem("last_orient")||"right",
teamList=[],
go,
scouting,
pitScouting,
subjectiveScouting,
storeTime=0,
h1Key='',
titleKey=''
parseHash()

onApplyTranslation.push(function(){
	setTranslationContext()
	$('title').text(translate(titleKey))
	$('h1').text(translate(h1Key))
})

function parseHash(){
	pos = (location.hash.match(/^\#(?:.*\&)?(?:pos\=)([RB][1-3])(?:\&.*)?$/)||["",""])[1]
	team = (location.hash.match(/^\#(?:.*\&)?(?:team\=)([0-9]+)(?:\&.*)?$/)||["",""])[1]
	orient = (location.hash.match(/^\#(?:.*\&)?(?:orient\=)(left|right)(?:\&.*)?$/)||["",orient])[1]
	match=(location.hash.match(/^\#(?:.*\&)?(?:match\=)((?:pm|qm|qf|sf|([1-5]p)|f)[0-9]+)(?:\&.*)?$/)||["",""])[1]
	teamList = (location.hash.match(/^\#(?:.*\&)?(?:teams\=)([0-9]+(?:,[0-9]+)*)(?:\&.*)?$/)||["",""])[1]
	go = (location.hash.match(/^\#(?:.*\&)?(?:go\=)(back)(?:\&.*)?$/)||["",""])[1]
	setTranslationContext()
}

function showScreen(){
	if (!team && $('#select-team').length && pitScouting.length) showSelectPitScoutTeam()
	else if (!team && $('#select-team').length && $('#subjective-scouting').length) showSelectSubjectiveScoutTeam()
	else if (team && $(pitScouting).length) showPitScoutingForm()
	else if (team && $('#subjective-scouting').length) showSubjectiveScoutingForm()
	else if (!pos) showPosList()
	else if (!match) showMatchList()
	else if (!team) showTeamChange()
	else showScouting()
	if(go=='back')history.back()
}

function maybeSaveFirst(){
	if (changedNotStored(getActiveForm())){
		if (confirm(translate('confirm_save_data_question'))) store()
	}
}

$(window).on('hashchange', function(){
	var current = buildHash(pos,orient,team,match,teamList)
	if (location.hash==current) return
	maybeSaveFirst()
	parseHash()
	showScreen()
	window.scrollTo(0,0)
})

function showSelectPitScoutTeam(){
	Promise.all([
		promiseEventTeams(),
		promisePitScouting()
	]).then(values=>{
		var [eventTeams, pitData] = values
		$('.screen,.init-hide').hide()
		resetInitialValues(pitScouting)
		setHash(null,null,null,null,teamList)
		window.scrollTo(0,0)
		titleKey='pit_scouting_select_team_title'
		h1Key='pit_scouting_select_team_heading'
		var el = $('#teamList').html(""),
		withData = getTeamsWithPitData(),
		showTeams = teamList?teamList.split(/,/).map(s=>parseInt(s)):eventTeams
		$('.location-pointer').remove()
		for (var i=0; i<showTeams.length;i++){
			var button = $('<button>').text(showTeams[i]).click(showPitScoutingForm)
			if (withData.hasOwnProperty(showTeams[i])||pitData[showTeams[i]]) button.addClass('stored')
			el.append(button)
		}
		$('#select-team').show()
		applyTranslations()
	})
}

function showSelectSubjectiveScoutTeam(){
	Promise.all([
		promiseEventTeams(),
		promiseSubjectiveScouting()
	]).then(values=>{
		var [eventTeams, subjectiveData] = values
		$('.screen,.init-hide').hide()
		resetInitialValues(subjectiveScouting)
		setHash(null,null,null,null,teamList)
		window.scrollTo(0,0)
		titleKey='subjective_scouting_select_team_title'
		h1Key='subjective_scouting_select_team_heading'
		var el = $('#teamList').html(""),
		withData = getTeamsWithSubjectiveData(),
		showTeams = teamList?teamList.split(/,/).map(s=>parseInt(s)):eventTeams
		$('.location-pointer').remove()
		for (var i=0; i<showTeams.length;i++){
			var button = $('<button>').text(showTeams[i]).click(showSubjectiveScoutingForm)
			if (withData.hasOwnProperty(showTeams[i])||subjectiveData[showTeams[i]]) button.addClass('stored')
			el.append(button)
		}
		$('#select-team').show()
		applyTranslations()
	})
}

function showTeamChange(){
	$('.screen,.init-hide').hide()
	location.hash=buildHash(pos,orient,null,match)
	resetInitialValues(scouting)
	window.scrollTo(0,0)
	titleKey='team_correction_title'
	h1Key='team_correction_heading'
	$('#teamChangeBtn').click(function(){
		team = $('#teamChange').val()
		showScouting()
		return false
	})
	$('#teamCancelBtn').click(function(){
		eventMatches.forEach(matchData=>{
			if (matchData.Match == match) team = matchData[pos]
		})
		if (team) showScouting()
		else showMatchList()
		return false
	})
	$('#change-team').show()
	applyTranslations()
}

function showPosList(){
	$('.screen,.init-hide').hide()
	setHash()
	window.scrollTo(0,0)
	titleKey='select_pos_title'
	h1Key='select_pos_heading'
	$('.orientLeft,.orientRight').show()
	$('#select-bot button').each(function(){
		$(this).toggleClass("highlighted", $(this).text() == localStorage.getItem("last_pos"))
	})
	$('#select-bot button').click(function(){
		pos = $(this).text()
		if (!BOT_POSITIONS.includes(pos)) return
		if ($(this).closest('.orientLeft').length) orient='left'
		if ($(this).closest('.orientRight').length) orient='right'
		showMatchList()
	})
	$('#select-bot').show()
	applyTranslations()
}

function showMatchList(){
	promiseEventStats().then(resolve=>{
		var [eventStats] = resolve
		$('.screen,.init-hide').hide()
		setHash(pos,orient)
		window.scrollTo(0,0)
		$('#match-list').html('')
		$('h1').text(`${eventName} ${pos}`)
		var alreadyScouted = {}
		forEachTeamMatch(eventStats, function(team,match){
			alreadyScouted[match]=1
		})
		alreadyScouted[localStorage.getItem("last_match_"+eventId)||""] = 1
		var lastDone
		for (var i=eventMatches.length-1; !lastDone && i>=0; i--){
			var m = eventMatches[i]['Match']
			if(alreadyScouted[m])lastDone=m
		}
		var seenLastDone = false;
		eventMatches.forEach(m => {
			var matchTeam = m[pos],
			matchId = m['Match'],
			matchName = getShortMatchName(matchId),
			completeClass=(lastDone&&!seenLastDone)?"complete":"",
			storedClass = (localStorage.getItem(getScoutKey(matchTeam, matchId)))?"stored":""
			if (lastDone == matchId) seenLastDone = true;
			$('#match-list').append(
				$('<div class=match>')
				.append($(`<button class="teamColorBG ${completeClass} ${storedClass}" data-team=${matchTeam} data-match=${matchId}>`).text(matchTeam).click(function(){
					team = $(this).attr('data-team')
					match=$(this).attr('data-match')
					setTranslationContext()
					showScouting()
				})).append($('<span>').text(' ' + matchName))
			)
		})
		setTeamBG()
		$('#select-match').show()
	})
}

function setTranslationContext(){
	addTranslationContext({
		pos:pos,
		teamNum:team,
		match:match,
		orient:orient,
		matchName:getMatchName(match),
		matchShort:getShortMatchName(match),
		eventName:eventName,
		teamColor:translate(pos.startsWith('R')?"red":"blue")
	})
}

function getKey(t,m,e){
	var form=getActiveForm()
	if (form === scouting) return getScoutKey(t,m,e)
	if (form === pitScouting) return getPitScoutKey(t,e)
	if (form === subjectiveScouting) return getSubjectiveScoutKey(t,e)
}

function getScoutKey(t,m,e){
	if (!t) t = team
	if (!m) m = match
	if (!e) e = eventId
	return `${e}_${m}_${t}`
}

function getPitScoutKey(t,e){
	if (!t) t = team
	if (!e) e = eventId
	return `${e}_${t}`
}

function getSubjectiveScoutKey(t,e){
	if (!t) t = team
	if (!e) e = eventId
	return `${e}_subjective_${t}`
}

function setHash(pos,orient,team,match,teamList){
	if(go=='back')return
	location.hash = buildHash(pos,orient,team,match,teamList)
	return false
}

function buildHash(pos,orient,team,match,teamList){
	return `#event=${eventId}`+
		(pos?`&pos=${pos}`:"")+
		(orient&&$('.orientLeft').length?`&orient=${orient}`:"")+
		(team?`&team=${team}`:"")+
		(match?`&match=${match}`:"")+
		(teamList?`&teams=${teamList}`:"")
}

function fillPreviousFormData(form,data){
	if (!data) return
	form.find('input,textarea').each(function(){
		var input = $(this),
		type = input.attr('type'),
		name = input.attr('name'),
		val = data[name]
		if (name){
			if (/^radio|checkbox$/.test(type)){
				var checked = input.attr('value')==val
				if(checked) input.attr('checked',"")
				else  input.removeAttr('checked')
				input.prop('checked',checked)
				input.attr('data-at-scout-start',checked?"checked":"unchecked")
			} else if (!/^submit$/.test(type) && val){
				input.attr('data-at-scout-start',val)
				input.val(val)
			}
		}
	})
}

function getValueAttrOrChecked(input){
	if (/^radio|checkbox$/.test(input.attr('type'))){
		var checked = input.attr('checked')
		return (typeof checked !== 'undefined' && checked !== false)?"checked":"unchecked"
	}
	return input.attr('value')||""
}

function getValOrChecked(input){
	if (/^radio|checkbox$/.test(input.attr('type'))) return input.prop('checked')?"checked":"unchecked"
	return input.val()||""
}

function storeInitialValues(form, type){
	if (!form.length)return
	localStorage.setItem(`${eventYear}_${type}headers`, toCSV(form)[0])
	form.find('input,textarea').each(function(){
		var input = $(this),
		atLoad = input.attr('data-at-page-load')
		if (typeof atLoad === 'undefined' || atLoad === false){
			var val = getValueAttrOrChecked(input)
			input.attr('data-at-page-load', val)
			input.attr('data-at-scout-start', val)
		}
	})
}
function resetInitialValues(form){
	form.find('input,textarea').each(function(){
		var input = $(this),
		type = input.attr('type'),
		atLoad = input.attr('data-at-page-load')
		if (typeof atLoad !== 'undefined' && atLoad !== false){
			if (/^radio|checkbox$/.test(type)){
				input.prop('checked',atLoad=='checked')
				input.attr('data-at-scout-start', atLoad)
			} else if (!/^submit$/.test(type)){
				input.val(atLoad)
				input.attr('data-at-scout-start', atLoad)
			}
		}
	})
}

function showPitScoutingForm(t){
	promisePitScouting().then(pitData=>{
		if (t && typeof t != 'number') t = parseInt($(this).text())
		if (t) team = t
		$('.screen,.init-hide').hide()
		h1Key='pit_scouting_heading'
		titleKey='pit_scouting_title'
		window.scrollTo(0,0)
		setHash(null,null,team,null,teamList)
		resetInitialValues(pitScouting)
		$('.location-pointer').remove()
		fillDefaultFormFields()
		fillPreviousFormData(pitScouting, localPitScoutingData(team)||pitData[team])
		promiseTeamsInfo().then(ti => {
			if (ti[team]){
				$('input[name="team_name"]').val(ti[team].nameShort).attr('value',ti[team].nameShort)
				var loc = `${ti[team].city}, ${ti[team].stateProv}, ${ti[team].country}`
				$('input[name="team_location"]').val(loc).attr('value',loc)
			}
		})
		resetSequentialInputSeries()
		$('.count').each(countHandler)
		for (var i=0; i<window.onShowPitScouting.length; i++){
			if(!window.onShowPitScouting[i]()) return false
		}
		pitScouting.show()
		setupButtons()
		localStorage.setItem("last_scout_type", "pit-scout")
		applyTranslations()
	})
}


function showSubjectiveScoutingForm(t){
	promiseSubjectiveScouting().then(subjectiveData=>{
		if (t && typeof t != 'number') t = parseInt($(this).text())
		if (t) team = t
		$('.screen,.init-hide').hide()
		$('h1').text("Subjective Scouting " + eventName + " Team " + team)
		window.scrollTo(0,0)
		setHash(null,null,team,null,teamList)
		var form = $('#subjective-scouting')
		resetInitialValues(form)
		$('.location-pointer').remove()
		fillDefaultFormFields()
		fillPreviousFormData(form, localSubjectiveScoutingData(team)||subjectiveData[team])
		resetSequentialInputSeries()
		$('.count').each(countHandler)
		for (var i=0; i<window.onShowSubjectiveScouting.length; i++){
			if(!window.onShowSubjectiveScouting[i]()) return false
		}
		form.show()
		setupButtons()
		localStorage.setItem("last_scout_type", "subjective-scout")
	})
}

function findParentFromButton(button){
	var name=button.attr('data-input'),
	parent = button,
	found = parent
	if (name){
		found = $(`input[name=${name}]`).parent('td')
	} else {
		for(var i=0;i<10;i++){
			if (parent.find('input').length == 1) found = parent
			parent = parent.parent()
		}
	}
	return found
}

function findInputInEl(parent){
	var input = findParentFromButton(parent).find('input')
	//if (!input.length) throw ("No input for counter")
	return input
}

var changeFloater = $('<div id=change-floater>')

var lastClickTimeOnCounter = 0
function countHandler(e){
	var clicked = e&&e.hasOwnProperty('type')&&e.type==='click'&&Math.abs(lastClickTimeOnCounter-e.timeStamp)>100,
	parent = findParentFromButton($(this)),
	count = $(this).is('.count')?$(this):$(this).find('.count').first(),
	input = findInputInEl(parent),
	src = count.attr('src'),
	val=parseInt(input.val())||0,
	max=parseInt(input.attr('max'))||999999,
	min=parseInt(input.attr('min'))||0
	if (parent.find('.disabledOverlay').is(':visible')) return
	if (clicked){
		lastClickTimeOnCounter=e.timeStamp
		var toAdd=1,
		oldVal=val
		if(/down/.test(src))toAdd = -1
		else if(/three/.test(src))toAdd = 3
		else if(/five/.test(src))toAdd = 5
		val+=toAdd
		val = val<min?min:val
		val = val>max?max:val
		var change = val-oldVal
		animateChangeFloater(change, e)
		inputChanged(input.val(val),change)
		parent.find('.count').each(countHandler)
	} else {
		if(/down/.test(count.attr('src'))){
			count.css('visibility', val<=min?'hidden':'visible');
		} else {
			count.css('visibility', val>=max?'hidden':'visible');
		}
	}
	return false
}

function animateChangeFloater(change, relative){
	if (change!=0){
		var x = relative.pageX?relative.pageX:(relative.offset().left+relative.width()/2),
		y = relative.pageY?relative.pageY:(relative.offset().top+relative.height()/2)
		changeFloater.text(((typeof change)!=='number'||change<0)?change:"+"+change).toggleClass("negative",change<0).css({top:y-changeFloater.height()/2,left:x-changeFloater.width()/2}).show()
		$('body').append(changeFloater)
	}
}

function showScouting(){
	promiseEventStats().then(resolve=>{
		var [_, _, eventStatsByMatchTeam] = resolve
		for (var i=0; i<window.onBeforeShowScouting.length; i++){
			if(!window.onBeforeShowScouting[i]()) return false
		}
		$('.screen,.init-hide').hide()
		resetInitialValues(scouting)
		setHash(pos,orient,team,match)
		window.scrollTo(0,0)
		if (typeof beforeShowScouting == 'function') beforeShowScouting()
		h1Key='scouting_heading'
		titleKey='scouting_title'
		$('.teamColor').text(pos.startsWith('R')?"red":"blue")
		$('.teamColorCaps').text(pos.startsWith('R')?"Red":"Blue")
		$('input[name="match"]').val(match).attr('data-at-scout-start',match)
		fillDefaultFormFields()
		setTeamBG()
		fillPreviousFormData(scouting, localScoutingData(team,match)||eventStatsByMatchTeam[`${match}-${team}`])
		$('.count').each(countHandler)
		resetSequentialInputSeries()
		$('#scouting-comments').toggle(!!window.showScoutingComments)
		for (var i=0; i<window.onShowScouting.length; i++){
			if(!window.onShowScouting[i]()) return false
		}
		showTab(null, $('.default-tab'))
		scouting.show()
		setupButtons()
		localStorage.setItem("last_scout_type", "scout")
		applyTranslations()
	})
}

function fillDefaultFormFields(){
	$('.team').text(team)
	$('input[name="event"]').val(eventId).attr('data-at-scout-start',eventId)
	$('input[name="team"]').val(team).attr('data-at-scout-start',team)
	var lastScouter = localStorage.getItem("last_scouter")||""
	$('input[name="scouter"]').val(lastScouter).attr('data-at-scout-start',lastScouter)
}

function setTeamBG(){
	$('.orientLeft').toggle(orient && orient=='left')
	$('.orientRight').toggle(orient && orient=='right')
	$('.teamColorBG').toggleClass('redTeamBG', pos.startsWith('R')).toggleClass('blueTeamBG', pos.startsWith('B'))
	$('.otherTeamBG').toggleClass('blueTeamBG', pos.startsWith('R')).toggleClass('redTeamBG', pos.startsWith('B'))
	$('body').toggleClass('redTeam', pos.startsWith('R')).toggleClass('blueTeam', pos.startsWith('B')).toggleClass('leftField', orient=='left').toggleClass('rightField', orient=='right')
}

function toggleChecked(o){
	o.each(function(){
		inputChanged($(this).prop('checked', !$(this).prop('checked')))
	})
}

function toCSV(form){
	var keys = [],
	values = {}
	form.find("input,textarea").each(function(){
		var el=$(this),name=el.attr('name'),val=el.val(),type=el.attr('type'),
		off=(type=='checkbox'||type=='radio')&&!el.prop('checked')
		if (!values.hasOwnProperty(name)){
			keys.push(name)
			values[name] = "0"
		}
		if (!off) values[name] = val
	})
	return [
		keys.map(safeCSV).join(",") + "\n",
		keys.map(k=>safeCSV(values[k])).join(",") + "\n"
	]
}

function getActiveForm(){
	if (window.scouting && scouting.length && scouting.is(':visible')) return scouting
	if (window.pitScouting && pitScouting.length && pitScouting.is(':visible')) return pitScouting
	if (window.subjectiveScouting && subjectiveScouting.length && subjectiveScouting.is(':visible')) return subjectiveScouting
	return null
}

function changedNotStored(form){
	if (!form) return false
	return formHasChanges(form) && new Date().getTime() - storeTime > 1000
}

window.addEventListener('beforeunload',(event) =>{
	if (changedNotStored(getActiveForm())){
		event.preventDefault()
		return "Leave page without saving?"
	}
})

function formHasChanges(f){
	var changes = false
	f.find('input,textarea').each(function(){
		var el=$(this),
		val=getValOrChecked(el),
		start=el.attr('data-at-scout-start')
		if (start !== undefined && val!==start)	changes=true
	})
	return changes
}

window.onStore = window.onStore || []
window.onShowScouting = window.onShowScouting || []
window.onBeforeShowScouting = window.onBeforeShowScouting || []
window.onShowPitScouting = window.onShowPitScouting || []
window.onShowSubjectiveScouting = window.onShowSubjectiveScouting || []
window.onInputChanged = window.onInputChanged || []

function setTimeStamps(form){
	var time = new Date().toISOString().replace(/\..*/,"+00:00"),
	created = form.find('input[name="created"]')
	if (created.length && !created.val()) created.val(time)
	form.find('input[name="modified"]').val(time)
}

function inputChanged(input, change){
	for (var i=0; i<window.onInputChanged.length; i++){
		if(!window.onInputChanged[i](input, change)) return false
	}
}

function storeScouter(form){
	localStorage.setItem('last_scouter',form.find('input[name="scouter"]').val())
}

function store(uploaded){
	var form = getActiveForm()
	if (form === scouting) return storeScouting(uploaded)
	if (form === pitScouting) return storePitScouting(uploaded)
	if (form === subjectiveScouting) return storeSubjectiveScouting(uploaded)
}

function getUploadedPrefix(uploaded){
	return uploaded=="uploaded"?"uploaded_":""
}

function storeScouting(uploaded){
	if (formHasChanges(scouting)){
		for (var i=0; i<window.onStore.length; i++){
			if(!window.onStore[i]()) return false
		}
		setTimeStamps(scouting)
		localStorage.setItem("last_match_"+eventId, match)
		localStorage.setItem("last_pos", pos)
		localStorage.setItem("last_orient", orient)
		var csv = toCSV(scouting)
		localStorage.setItem(`${eventYear}_headers`, csv[0])
		localStorage.setItem(getUploadedPrefix(uploaded)+getScoutKey(), csv[1])
		storeTime = new Date().getTime()
		storeScouter(scouting)
	}
	return true
}

function storePitScouting(uploaded){
	var f=pitScouting
	if (formHasChanges(f)){
		setTimeStamps(f)
		var csv = toCSV(pitScouting)
		localStorage.setItem(`${eventYear}_pitheaders`, csv[0])
		localStorage.setItem(getUploadedPrefix(uploaded)+getPitScoutKey(), csv[1])
		storeTime = new Date().getTime()
		storeScouter(f)
	}
}
function storeSubjectiveScouting(uploaded){
	var f=subjectiveScouting
	if (formHasChanges(f)){
		setTimeStamps(f)
		var csv = toCSV(subjectiveScouting)
		localStorage.setItem(`${eventYear}_subjectiveheaders`, csv[0])
		localStorage.setItem(getUploadedPrefix(uploaded)+getSubjectiveScoutKey(), csv[1])
		storeTime = new Date().getTime()
		storeScouter(f)
	}
}

function localPitScoutingData(t){
	var data = localStorage.getItem(getPitScoutKey(t))
	if (!data) return null
	return csvToArrayOfMaps(localStorage.getItem(`${eventYear}_pitheaders`)+"\n"+data)[0]
}

function localSubjectiveScoutingData(t){
	var data = localStorage.getItem(getSubjectiveScoutKey(t))
	if (!data) return null
	return csvToArrayOfMaps(localStorage.getItem(`${eventYear}_subjectiveheaders`)+"\n"+data)[0]
}

function localScoutingData(t,m){
	var data = localStorage.getItem(getScoutKey(t,m))
	if (!data) return null
	return csvToArrayOfMaps(localStorage.getItem(`${eventYear}_headers`)+"\n"+data)[0]
}

function safeCSV(s){
	return s
		.replace(/\t/g, " ")
		.replace(/\r|\n|\r\n/g, "⏎")
		.replace(/\"/g, "״")
		.replace(/,/g, "،")
}

function getTeamsWithData(){
	var teams = {}
	teams[team]=1
	for (var i in localStorage){
		if (/^20[0-9]{2}.*_.*_[0-9]+$/.test(i)){
			var t = parseInt(i.replace(/.*_/,""))
			teams[t]=1
		}
	}
	return teams
}


function getTeamsWithPitData(){
	var teams = {}
	for (var i in localStorage){
		if (/^20[0-9]{2}[a-zA-Z0-9\-]+_[0-9]+$/.test(i)){
			var t = parseInt(i.replace(/.*_/,""))
			teams[t]=1
		}
	}
	return teams
}

function getTeamsWithSubjectiveData(){
	var teams = {}
	for (var i in localStorage){
		if (/^20[0-9]{2}[a-zA-Z0-9\-]+_subjective_[0-9]+$/.test(i)){
			var t = parseInt(i.replace(/.*_/,""))
			teams[t]=1
		}
	}
	return teams
}

function pitScoutNext(uploaded){
	if (uploaded!="uploaded") localStorage.setItem("last_scout_action","next")
	storePitScouting(uploaded)
	showSelectPitScoutTeam()
	return false
}

function subjectiveScoutNext(uploaded){
	if (uploaded!="uploaded") localStorage.setItem("last_scout_action","next")
	storeSubjectiveScouting(uploaded)
	showSelectSubjectiveScoutTeam()
	return false
}

function goChooseMatch(){
	localStorage.setItem("last_scout_action","match")
	maybeSaveFirst()
	showMatchList()
	return false
}

function goChooseRobot(){
	localStorage.setItem("last_scout_action","robot")
	maybeSaveFirst()
	showPosList()
	return false
}

function rotateField(){
	orient=orient=='right'?"left":"right"
	setTeamBG()
	setHash(pos,orient,team,match)
	return false
}

function goChangeTeam(){
	localStorage.setItem("last_scout_action","team")
	maybeSaveFirst()
	showTeamChange()
	return false
}

function goNext(uploaded){
	if (uploaded!="uploaded") localStorage.setItem("last_scout_action","next")
	var form=getActiveForm()
	if (form===scouting)return goNextMatch(uploaded)
	if (form===pitScouting)return pitScoutNext(uploaded)
	if (form===subjectiveScouting)return subjectiveScoutNext(uploaded)
}

function goNextMatch(uploaded){
	if (!store(uploaded)) return false
	var next = getNextMatch()
	if (!next){
		alert(translate("done_scouting"))
	} else {
		team = next[pos]
		match=next['Match']
		setTranslationContext()
		showScouting()
	}
	return false
}

function goUploadData(){
	localStorage.setItem("last_scout_action","upload")
	if (!store()) return false
	location.href="/upload.html"
	return false
}

var qrNum=0,
qrUrls=[]
function nextQrCode(){
	showQrCode(qrNum+1)
}

function getQrUrls(){
	var csv=toCSV(getActiveForm())[1].trim(),
	csvIndex=0,
	urls=[]
	csv=csv.replace(/,0(?=,)/g,",")
	for (var i=1;csvIndex<csv.length;i++){
		var parts=[location.origin,"/qr.html?"]
		if(i>1)parts.push(`${i}...`)
		parts.push(getKey(),",")
		var len=parts.reduce((sum,v)=>sum+v.length,0)
		while(csvIndex<csv.length && len<1000){
			var next=encodeURIComponent(csv[csvIndex])
			len+=next.length
			parts.push(next)
			csvIndex++
		}
		if (csvIndex<csv.length) parts.push(`...${i+1}`)
		urls.push(parts.join(''))
	}
	return urls
}

function showQrCode(num){
	localStorage.setItem("last_scout_action","qr")
	if (typeof num == 'object'){
		qrUrls = getQrUrls()
		num=1
	}
	qrNum=num
	if (num>qrUrls.length){
		closeLightBox()
		goNext("uploaded")
		return false
	}
	var dialog=$('#qr-code-dialog')
	if (!dialog.length){
		dialog=$('<div id=qr-code-dialog class=lightBoxCenterContent>')
		.append($('<h2 id=qr-code-title>'))
		.append($('<div id=qr-code style="border:.5em solid white">'))
		.append($('<p>')
			.append($('<button data-i18n=cancel_button>').click(closeLightBox))
			.append(" ")
			.append($('<button style=float:right data-i18n=next_button>').click(nextQrCode))
		)
		$('body').append(dialog)
	}
	$('#qr-code-title').text(`QR Code ${qrNum} of ${qrUrls.length}`)
	var size = Math.min($('body').innerWidth()-20,$('body').innerHeight()-20,700)
	new QRCode($("#qr-code").html("").click(copyTitleAttr)[0],{
		text:qrUrls[num-1],
		width:size,
		height:size,
		correctLevel:QRCode.CorrectLevel.L,
	})
	showLightBox(dialog)
	return false
}

function copyTitleAttr(){
	navigator.clipboard.writeText($(this).attr('title'))
}

function setupButtons(){
	var featured='next',
	doneButtons=$('#doneButtons'),
	featuredButton=$('<div id=featuredButton>'),
	otherButtons=$('<div id=otherButtons>')
	if("qr"==localStorage.getItem("last_scout_action")) featured="qr"
	else if(getActiveForm()===scouting){
		var next = getNextMatch()
		if(!next || haveDataForMatch(next) || haveAllDataForOurNextMatch()) featured='upload'
	}
	addButtons(featuredButton,featured,true)
	addButtons(otherButtons,featured,false)
	doneButtons.html("").append(featuredButton).append(otherButtons)
}

function addButtons(div, featured, isFeatured){
	if (getActiveForm()===scouting){
		if((featured=='next')==isFeatured) div.append($('<button data-i18n=next_match_button>').click(goNext)).append(" ")
		if((featured=='upload')==isFeatured) div.append($('<button data-i18n=upload_data_button>').click(goUploadData)).append(" ")
		if((featured=='qr')==isFeatured) div.append($('<button data-i18n=qr_code_button>').click(showQrCode)).append(" ")
		if($('#matchBtn').length==0 && !isFeatured) div.append($('<button data-i18n=choose_match_button>').click(goChooseMatch)).append(" ")
		if($('.robotBtn').length==0 && !isFeatured) div.append($('<button data-i18n=change_robot_button>').click(goChooseRobot)).append(" ")
	} else {
		if((featured=='next')==isFeatured) div.append($('<button data-i18n=save_button>').click(goNext)).append(" ")
		if((featured=='qr')==isFeatured) div.append($('<button data-i18n=qr_code_button>').click(showQrCode)).append(" ")
	}
}

function haveDataForMatch(m){
	if (!m) return 0
	var have = getTeamsWithData()
	return BOT_POSITIONS.reduce((sum,pos)=>sum+(have[m[pos]]?1:0),0)
}

function haveAllDataForOurNextMatch(){
	if (!window.ourTeam) return 0
	var seenCurrentMatch = 0
	var toBeCollected = {}
	for (var i=0; i<eventMatches.length; i++){
		var m = eventMatches[i]
		if (!seenCurrentMatch){
			if (match == m.Match) seenCurrentMatch = 1
		} else if (matchHasTeam(m, window.ourTeam)){
			if (!haveDataForMatch(m)) return 0
			return !(BOT_POSITIONS.reduce((sum,pos)=>sum|(toBeCollected[m[pos]]?1:0),0))
		} else {
			toBeCollected[m[pos]]=1
		}
	}
	return 0
}

function getNextMatch(){
	for (var i=0; i<eventMatches.length; i++){
		if (match == eventMatches[i]['Match']){
			if (i+1 >= eventMatches.length) return 0
			return eventMatches[i+1]
		}
	}
	return 0
}

function showTab(event, tab){
	var button = (tab||$(this)),
	name = button.attr('data-content'),
	tab=$(`.tab[data-content="${name}"]`)
	$('.tab').removeClass("redTeamBG").removeClass("blueTeamBG")
	tab.addClass(pos.startsWith('R')?"redTeamBG":"blueTeamBG")
	$('.tab-content').hide()
	$(`.${name}`).show()
	if(button.is('.tab-button')) window.scrollTo(tab.offset())
	return false
}

function toggleCollapse(_,c){
	c = c||$(this)
	var content=$(`#${c.attr('data-content')}`)
	content.toggle()
	c.toggleClass('open',content.is(':visible'))
}

var eventMatches

function labelClicked(e){
	e.preventDefault()
	var check=$(this).find(':checkbox,:radio')
	if (check.attr('disabled') && !check.prop('checked')) return
	toggleChecked(check)
}

$(document).ready(function(){
	if (!eventYear || !eventVenue){
		showError('event_not_found')
		applyTranslations()
		return
	}

	scouting = $('#scouting')
	pitScouting = $('#pit-scouting')
	subjectiveScouting = $('#subjective-scouting')

	storeInitialValues(scouting,"")
	storeInitialValues(pitScouting,"pit")
	storeInitialValues(subjectiveScouting,"subjective")

	$('.tab,.tab-button').click(showTab)
	$('.collapse').click(toggleCollapse)

	$('title').text($('title').text().replace(/EVENT/g, eventName))


	promiseEventMatches().then(em => {
		eventMatches = em
		showScreen()
	})

	$("label").click(labelClicked)

	$("input,textarea").focus(function(){
		// Select pre-filled input values
		if ($(this).attr('disabled')) return
		if (!$(this).attr('value')) return
		if (/^radio|checkbox|submit$/i.test($(this).attr('type'))) return
		if ($(this).attr('value') != $(this).val()) return
		$(this).one('mouseup',function(){
			$(this).select()
			return false
		}).select()
	})

	$("img.count,button.count").click(countHandler).each(function(){
		findParentFromButton($(this)).click(countHandler)
	})

	$("img.robot-location").click(function(e){
		var x = Math.round(1000 * (e.pageX - this.offsetLeft) / this.width)/10,
		y = Math.round(1000 * (e.pageY - this.offsetTop) / this.height)/10,
		inp = $(this).parent().find('input'),
		name = inp.attr('name')
		$(`.${name}`).remove()
		$('body').append($('<img class=location-pointer src=/pointer.png style="position:absolute;width:3em">').css('top',e.pageY).css('left',e.pageX).addClass(name))
		inputChanged(inp.val(val), `${x}%x${y}%`)
	})
	$("#nextBtn,#pitScoutNext,#pitTeamButton,#subjectiveScoutNext,#subjectiveTeamButton").click(goNext)
	$("#matchBtn").click(goChooseMatch)
	$(".robotBtn").click(goChooseRobot)
	$(".fieldRotateBtn").click(rotateField)
	$("#teamBtn").click(goChangeTeam)
	$('.showInstructions').click(function(e){
		e.preventDefault()
		showLightBox($(this).parent().find('.instructions'))
		return false
	})
	$("#uploadBtn").click(goUploadData)

	$('img.expandable-image').click(function(){
		showLightBox($('#lightBoxImage').html("").append($('<img>').attr('src',$(this).attr('src')).addClass('full-image')))
	})

	$('.sequential-input-series textarea,.sequential-input-series input[type="text"]').change(function(){
		var name = $(this).attr('name'),
		n = /[0-9]/.exec(name),
		next = name.replace(n,parseInt(n)+1)
		$('textarea[name='+next+'],input[name='+next+']').closest('.sequential-input-series').show()
	})
})

function resetSequentialInputSeries(){
	$('.sequential-input-series textarea,.sequential-input-series input[type="text"]').each(function(){
		var name = $(this).attr('name'),
		n = /[0-9]/.exec(name),
		next = name.replace(n,parseInt(n)+1)
		$('textarea[name='+next+'],input[name='+next+']').closest('.sequential-input-series').toggle($(this).val()!="")
	})
}

function showError(key){
	var error=$('#error')
	if (!error.length){
		error=$('<div id=error class=screen><h1></h1></div>')
		$('body').append(error)
	}
	h1Key=titleKey=key
	applyTranslations()
}
