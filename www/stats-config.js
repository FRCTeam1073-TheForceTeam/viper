"use strict"

addI18n({
	validate_error_only_graph:{
		en:'Expected only data in "_PROBLEMTEXT_"',
		tr:'Yalnızca "_PROBLEMTEXT_" içindeki veriler bekleniyor',
		pt:'Esperados apenas dados em "_PROBLEMTEXT_"',
		fr:'Données attendues uniquement dans « _PROBLEMTEXT_ »',
		he:'צפוי רק נתונים ב-"_PROBLEMTEXT_"',
		zh_tw:'僅需“_PROBLEMTEXT_”中的數據',
	},
	remove_section_confirm:{
		en:'Are you sure you want to remove this section?',
		tr:'Bu bölümü kaldırmak istediğinizden emin misiniz?',
		pt:'Tem certeza de que deseja remover esta seção?',
		fr:'Voulez-vous vraiment supprimer cette section ?',
		he:'האם אתה בטוח שברצונך להסיר את הקטע הזה?',
		zh_tw:'您確實要刪除此部分嗎？',
	},
	validate_error_json_not_array:{
		en:'JSON is not an array',
		fr:'JSON n\'est pas un tableau',
		he:'JSON אינו מערך',
		pt:'JSON não é um array',
		zh_tw:'JSON 不是數組',
		tr:'JSON bir dizi değil',
	},
	validate_error_json_not_map:{
		en:'JSON is not a map',
		fr:'JSON n\'est pas une carte',
		he:'JSON אינו מפה',
		pt:'JSON não é um mapa',
		zh_tw:'JSON 不是地圖',
		tr:'JSON bir harita değil',
	},
	validate_error_no_fields:{
		en:'Error: No fields in list',
		fr:'Erreur : Aucun champ dans la liste',
		he:'שגיאה: אין שדות ברשימה',
		pt:'Erro: Nenhum campo na lista',
		zh_tw:'錯誤：清單中沒有字段',
		tr:'Hata: Listede alan yok',
	},
	validate_error_no_name:{
		en:'Error: Name not specified',
		fr:'Erreur : Nom non spécifié',
		he:'שגיאה: השם לא צוין',
		pt:'Erro: Nome não especificado',
		zh_tw:'錯誤：未指定名稱',
		tr:'Hata: Ad belirtilmemiş',
	},
	validate_error_not_string:{
		en:'_PROBLEMTEXT_ is not a string',
		fr:'_PROBLEMTEXT_ n\'est pas une chaîne',
		zh_tw:'_PROBLEMTEXT_ 不是字串',
		pt:'_PROBLEMTEXT_ não é uma sequência',
		he:'_PROBLEMTEXT_ אינו מחרוזת',
		tr:'_PROBLEMTEXT_ bir dize değil',
	},
	validate_error_unknown_data:{
		en:'Unknown data: _PROBLEMTEXT_',
		fr:'Données inconnues : _PROBLEMTEXT_',
		zh_tw:'未知資料：_PROBLEMTEXT_',
		pt:'Dados desconhecidos: _PROBLEMTEXT_',
		he:'נתונים לא ידועים: _PROBLEMTEXT_',
		tr:'Bilinmeyen veri: _PROBLEMTEXT_',
	},
	validate_error_need_symbol:{
		en:'Expected _EXPECTEDTEXT_ following _PROBLEMTEXT_',
		fr:'_EXPECTEDTEXT_ attendu après _PROBLEMTEXT_',
		zh_tw:'_PROBLEMTEXT_ 之後應為 _EXPECTEDTEXT_',
		pt:'Esperado _EXPECTEDTEXT_ seguindo _PROBLEMTEXT_',
		he:'צפוי _EXPECTEDTEXT_ בעקבות _PROBLEMTEXT_',
		tr:'_PROBLEMTEXT_\'i takip eden _EXPECTEDTEXT_ bekleniyor',
	},
	validate_error_not_all_strings:{
		en:'_PROBLEMTEXT_ is not all strings',
		fr:'_PROBLEMTEXT_ n\'est pas composé uniquement de chaînes',
		zh_tw:'_PROBLEMTEXT_ 並非全部都是字串',
		pt:'_PROBLEMTEXT_ não é todas as sequências',
		he:'_PROBLEMTEXT_ אינו הכל מחרוזות',
		tr:'_PROBLEMTEXT_ tüm dizeler değil',
	},
	validate_error_not_array:{
		en:'_PROBLEMTEXT_ is not an array',
		fr:'_PROBLEMTEXT_ n\'est pas un tableau',
		zh_tw:'_PROBLEMTEXT_ 不是數組',
		pt:'_PROBLEMTEXT_ não é uma matriz',
		he:'_PROBLEMTEXT_ אינו מערך',
		tr:'_PROBLEMTEXT_ bir dizi değil',
	},
	validate_error_empty:{
		en:'_PROBLEMTEXT_ is empty',
		fr:'_PROBLEMTEXT_ est vide',
		zh_tw:'_PROBLEMTEXT_ 為空',
		pt:'_PROBLEMTEXT_ está vazio',
		he:'_PROBLEMTEXT_ ריק',
		tr:'_PROBLEMTEXT_ boş',
	},
	validate_error_only_graph:{
		en:'Expected only graph and data in "_PROBLEMTEXT_"',
		fr:'Seulement le graphique et les données attendus dans « _PROBLEMTEXT_ »',
		zh_tw:'“_PROBLEMTEXT_”中僅應包含圖表和數據',
		pt:'Esperado apenas gráfico e dados em "_PROBLEMTEXT_"',
		he:'צפוי רק גרף ונתונים ב-"_PROBLEMTEXT_"',
		tr:'Yalnızca "_PROBLEMTEXT_" içindeki grafik ve veriler bekleniyor',
	},
	add_label:{
		en:'Add:',
		fr:'Ajouter :',
		zh_tw:'添加：',
		pt:'Adicionar:',
		he:'לְהוֹסִיף:',
		tr:'Ekle:',
	},
	graph_bar:{
		en:'Bar chart',
		fr:'Graphique à barres',
		zh_tw:'長條圖',
		pt:'Gráfico de barras',
		he:'תרשים עמודות',
		tr:'Çubuk grafik',
	},
	graph_boxplot:{
		en:'Box plot',
		fr:'Box plot',
		zh_tw:'箱線圖',
		pt:'Plotagem de caixa',
		he:'עלילת קופסה',
		tr:'Kutu grafiği',
	},
	graph_heatmap:{
		en:'Heatmap',
		fr:'Carte thermique',
		zh_tw:'熱圖',
		pt:'Mapa de calor',
		he:'מפת חום',
		tr:'Isı haritası',
	},
	graph_stacked:{
		en:'Stacked bars',
		fr:'Barres empilées',
		zh_tw:'堆疊長條圖',
		pt:'Barras empilhadas',
		he:'סורגים מוערמים',
		tr:'Yığılmış çubuklar',
	},
	graph_stacked_percent:{
		en:'Stacked percents',
		fr:'Pourcentages empilés',
		zh_tw:'堆疊百分比',
		pt:'Porcentagens empilhadas',
		he:'אחוזים מוערמים',
		tr:'Yığılmış yüzdeler',
	},
	graph_timeline:{
		en:'Timeline',
		fr:'Chronologie',
		zh_tw:'時間軸',
		pt:'Linha do tempo',
		he:'ציר זמן',
		tr:'Zaman çizelgesi',
	},
	graph_name_placeholder:{
		en:'Name of graph',
		fr:'Nom du graphique',
		zh_tw:'圖表名稱',
		pt:'Nome do gráfico',
		he:'שם הגרף',
		tr:'Grafik adı',
	},
	section_name_placeholder:{
		en:'Name of section',
		fr:'Nom de la section',
		zh_tw:'部分名稱',
		pt:'Nome da seção',
		he:'שם המדור',
		tr:'Bölüm adı',
	},
	remove_link:{
		en:'Remove',
		fr:'Supprimer',
		zh_tw:'消除',
		pt:'Remover',
		he:'לְהַסִיר',
		tr:'Kaldır',
	},
	remove_graph_confirm:{
		en:'Are you sure you want to remove this graph?',
		fr:'Êtes-vous sûr de vouloir supprimer ce graphique ?',
		zh_tw:'您確定要刪除該圖表嗎？',
		pt:'Tem certeza de que deseja remover este gráfico?',
		he:'האם אתה בטוח שברצונך להסיר את הגרף הזה?',
		tr:'Bu grafiği kaldırmak istediğinizden emin misiniz?',
	},
	manage_graphs_heading:{
		en:'Manage Graphs',
		fr:'Gérer les graphiques',
		zh_tw:'管理圖表',
		pt:'Gerenciar gráficos',
		he:'נהל גרפים',
		tr:'Grafikleri Yönet',
	},
	manage_stats_heading:{
		en:'Manage Stats',
		fr:'Gérer les statistiques',
		zh_tw:'管理統計數據',
		pt:'Gerenciar estatísticas',
		he:'נהל סטטיסטיקות',
		tr:'İstatistikleri Yönet',
	},
	edit_json_link:{
		en:'Edit JSON',
		fr:'Modifier le JSON',
		zh_tw:'編輯 JSON',
		pt:'Editar JSON',
		he:'ערוך את JSON',
		tr:'JSON\'u Düzenle',
	},
	download_data_link:{
		en:'Download Data',
		fr:'Télécharger les données',
		zh_tw:'下載數據',
		pt:'Baixar dados',
		he:'הורד נתונים',
		tr:'Verileri İndir',
	},
	add_graph_link:{
		en:'Add Graph',
		fr:'Ajouter un graphique',
		zh_tw:'新增圖表',
		pt:'Adicionar gráfico',
		he:'הוסף גרף',
		tr:'Grafik Ekle',
	},
	add_section_link:{
		en:'Add Section',
		fr:'Ajouter une section',
		zh_tw:'添加部分',
		pt:'Adicionar seção',
		he:'הוסף סעיף',
		tr:'Bölüm Ekle',
	},
	save_to_server_link:{
		en:'Save to Server',
		fr:'Enregistrer sur le serveur',
		zh_tw:'保存到伺服器',
		pt:'Salvar no servidor',
		he:'שמור בשרת',
		tr:'Sunucuya Kaydet',
	},
	revert_personal_link:{
		en:'Revert Personal Customizations',
		fr:'Annuler les personnalisations personnelles',
		zh_tw:'恢復個人自訂',
		pt:'Reverter personalizações pessoais',
		he:'החזר התאמות אישיות',
		tr:'Kişisel Özelleştirmeleri Geri Al',
	},
	revert_personal_confirm:{
		en:'Are you sure you want delete ALL your personal custom graph configuration?',
		fr:'Voulez-vous vraiment supprimer TOUTES vos configurations de graphiques personnalisées ?',
		zh_tw:'您確定要刪除所有個人自訂圖形配置嗎？',
		pt:'Tem certeza de que deseja excluir TODAS as suas configurações de gráfico personalizado pessoal?',
		he:'האם אתה בטוח שברצונך למחוק את כל תצורת הגרפים המותאמים אישית שלך?',
		tr:'TÜM kişisel özel grafik yapılandırmanızı silmek istediğinizden emin misiniz?',
	},
	revert_all_link:{
		en:'Revert All Customizations',
		fr:'Annuler toutes les personnalisations',
		zh_tw:'恢復所有自訂',
		pt:'Reverter todas as personalizações',
		he:'החזר את כל ההתאמות האישיות',
		tr:'Tüm Özelleştirmeleri Geri Al',
	},
	revert_all_confirm:{
		en:'Are you sure you want delete ALL your personal AND team\'s custom graph configuration?',
		fr:'Voulez-vous vraiment supprimer TOUTES vos configurations de graphiques personnalisées personnelles ET celles de votre équipe ?',
		zh_tw:'您確定要刪除您個人和團隊的所有自訂圖表配置嗎？',
		pt:'Tem certeza de que deseja excluir TODAS as suas configurações de gráfico personalizado pessoal E da equipe?',
		he:'האם אתה בטוח שברצונך למחוק את כל תצורת הגרפים האישיים שלך ושל הצוות שלך?',
		tr:'TÜM kişisel ve ekibinizin özel grafik yapılandırmasını silmek istediğinizden emin misiniz?',
	},
})

function isArray(o){
	return typeof o === 'object' && o instanceof Array
}

function isMap(o){
	return typeof o === 'object' && !(o instanceof Array)
}

function isString(o){
	return typeof o === 'string'
}

var numericGraphTypes=new Set(['%','avg','count','capability','fraction','minmax','num','ratio'])

var graphTypes={
	"bar":{
		types: numericGraphTypes,
		modes: new Set(['aggregate','team'])
	},
	"boxplot":{
		types: new Set(['%','avg','count','minmax']),
		modes: new Set(['aggregate'])
	},
	"heatmap":{
		types: new Set(['heatmap']),
		modes: new Set(['aggregate','team'])
	},
	"stacked":{
		types: numericGraphTypes,
		modes: new Set(['aggregate','team'])
	},
	"stacked_percent":{
		types: new Set(['count']),
		modes: new Set(['aggregate'])
	},
	"timeline":{
		types: new Set(['timeline']),
		modes: new Set(['team'])
	},
}

class StatsConfig {
	constructor(conf){
		this.statsConfigKey=conf.statsConfigKey
		this.getStatsConfig=conf.getStatsConfig
		this.hasSections=!!conf.hasSections
		this.hasGraphs=!!conf.hasGraphs
		this.hasWhiteboard=!!conf.hasWhiteboard
		this.drawFunction=conf.drawFunction
		this.fileName=conf.fileName
		this.defaultConfig=conf.defaultConfig
		this.downloadBlobs=conf.downloadBlobs
		this.mode=conf.mode
		this.team=conf.team
	}

	validateJson(json){
		if (!this.hasSections){
			if (!isArray(json)) throw(translate('validate_error_json_not_array'))
			json.forEach(this.validateItem.bind(this))
		} else {
			if (!isMap(json)) throw(translate('validate_error_json_not_map'))
			Object.keys(json).forEach(section=>this.validateItem(json[section],section))
		}
	}

	validateItem(item, name){
		if (!this.hasSections){
			if (!isString(item))throw(translate('validate_error_not_string',{problemText:item}))
			if (!statInfo[item])throw(translate('validate_error_unknown_data',{problemText:item}))
		} else {
			if (!isMap(item))throw(translate('validate_error_need_symbol',{expectedText:':{',problemText:name}))
			if (this.hasGraphs&&!isString(item.graph))throw(translate('validate_error_not_string',{problemText:`${name}.graph`}))
			if (!isArray(item.data))throw(translate('validate_error_not_string',{problemText:`${name}.data`}))
			if (item.data.length==0)throw(translate('validate_error_empty',{problemText:`${name}.data`}))
			item.data.forEach(function(field){
				if (!isString(field))throw(translate('validate_error_not_all_strings',{problemText:`${name}.data`}))
				if (!statInfo[field])throw(translate('validate_error_unknown_data',{problemText:field}))
			})
			if (this.hasGraphs&&Object.keys(item).length!=2)throw(translate('validate_error_only_graph',{problemText:name}))
			if (!this.hasGraphs&&Object.keys(item).length!=1)throw(translate('validate_error_only_data',{problemText:name}))
		}
	}

	getLocalStatsConfig(){
		var s=localStorage.getItem(this.statsConfigKey)
		if (s && s != 'undefined'){
			try {
				s=JSON.parse(s)
				if (Object.keys(s).length) return s
			} catch (e){
				console.error(e)
			}
		}
		return null
	}

	saveJson(){
		try{
			var json=JSON.parse($('#stats-export-json').val())
			this.validateJson(json)
			localStorage.setItem(this.statsConfigKey, JSON.stringify(json))
		} catch(e){
			alert(e)
			throw e
		}
		closeLightBox()
		this.drawFunction()
		return false
	}

	cleanConfig(json){
		if (this.hasSections){
			Object.keys(json).forEach(section=>this.cleanItem(json[section]))
		}
		return json
	}

	cleanItem(item){
		Object.keys(item).forEach(x=>{
			try{
				if (x!='data'&&(x!='graph'||!this.hasGraphs))delete item[x]
			}catch(e){}
		})
	}

	translateConfig(json){
		if (this.hasSections){
			Object.keys(json).forEach(name=>{
				var x=json[name]
				delete json[name]
				json[translate(name)]=x
			})
		}
		return json
	}

	showExportDialog(){
		if(!this.hasSections)this.ui2Json()
		var dialog=$('#stats-export')
		if (!dialog.length){
			dialog=$('<div id=stats-export class=lightBoxCenterContent>')
			.append(
				$('<textarea id=stats-export-json style=display:block;width:98vw;max-width:30em;height:90vh;max-height:60em>')
			).append($('<button data-i18n=save_button></button>').click(this.saveJson.bind(this))).append(" ")
			.append($('<button data-i18n=cancel_button></button>').click(closeLightBox))
			$('body').append(dialog)
		}
		$('#stats-export-json').val(JSON.stringify(this.translateConfig(this.cleanConfig(this.getStatsConfig())),null,2))
		applyTranslations(dialog)
		showLightBox(dialog)
		return false
	}

	ui2Json(){
		var fields=$("#stats-config-fields li").map(function(){return $(this).attr("data-field")}).get(),
		stats=this.cleanConfig(this.getStatsConfig())
		if (!fields.length) return alert(translate('validate_error_no_fields'))
		if (this.hasSections){
			var sectionName=$('#stats-config-section-name'),
			oldSectionName=sectionName.attr('old-name'),
			newSectionName=sectionName.val()
			if (!newSectionName) return alert(translate('validate_error_no_name'))
			if (oldSectionName != newSectionName) delete stats[oldSectionName]
			if (this.hasGraphs){
				stats[newSectionName]={
					graph: $('#stats-config-graph-type').val(),
					data: fields
				}
			} else {
				stats[newSectionName]=fields
			}
		} else {
			stats=fields
		}
		localStorage.setItem(this.statsConfigKey, JSON.stringify(stats))

	}

	save(){
		this.ui2Json()
		closeLightBox()
		this.drawFunction()
	}

	handleAddFieldChange(e){
		var field=$(e.target).val()
		if (field) this.addFieldToStatsConfig(field)
		$(e.target).val('')
	}

	appendFieldList(dialog){
		dialog.append($('<ul id=stats-config-fields>'))
		.append('<span data-i18n=add_label></span> ').append($('<select id=stats-config-add-field>').change(this.handleAddFieldChange.bind(this)))
		.append(
			$('<p>').append($('<button data-i18n=save_button></button>').click(this.save.bind(this)))
			.append(" ").append($('<button data-i18n=cancel_button></button>').click(closeLightBox))
		)
	}

	saveToServer(){
		if(!this.hasSections)this.ui2Json()
		var form=$('#stats-config-save-form')
		if (!form.length){
			form=$('<form method=POST action=/admin/stats-config.cgi id=stats-config-save-form>')
			.append($('<input type=hidden name=return>').val(location.pathname+location.search+location.hash))
			.append($('<input type=hidden name=season>').val(eventYear))
			.append($('<input type=hidden name=type>').val(this.fileName))
			.append($('<input type=hidden name=conf>'))
			$('body').append(form)
		}
		form.find('[name="conf"]').val(JSON.stringify(this.cleanConfig((this.getStatsConfig()))))
		form.submit()
		return false
	}

	revertPersonalCustomizations(){
		if (confirm(translate('revert_personal_confirm'))){
			localStorage.removeItem(this.statsConfigKey)
			closeLightBox()
			this.drawFunction()
		}
		return false
	}

	revertAllCustomizations(){
		if (confirm(translate('revert_all_confirm'))){
			localStorage.setItem(this.statsConfigKey, this.cleanConfig(JSON.stringify(this.defaultConfig)))
			closeLightBox()
			this.drawFunction()
		}
		return false
	}

	handleChangeGraphType(e){
		var me=this,
		type = $(e.target).val()
		$('#stats-config-fields li').each(function(){
			var field = $(this).attr('data-field')
			if (!me.graphTypeOk(field,type))$(this).remove()
		})
		this.populateAddFields()
	}

	graphTypeOk(field,types){
		var modes = new Set()
		if (typeof types == 'string'){
			types=graphTypes[types]
			modes=types.modes
			types=types.types
		}
		return statInfo[field] && statInfo[field].type && types.has(statInfo[field].type) && (!this.mode || modes.has(this.mode))
	}

	showEditSectionDialog(e){
		var me=this,
		section=$(e.target).attr('data-section'),
		dialog=$('#stats-config-edit')
		if (!dialog.length){
			dialog=$('<div id=stats-config-edit class=lightBoxCenterContent style=display:none>')
			.append($(`<p><input id=stats-config-section-name type=text style=width:100% data-i18n-placeholder="${this.hasGraphs?'graph_name_placeholder':'section_name_placeholder'}"></p>`))
			if (me.hasGraphs)dialog.append($('<p>').append($('<select id=stats-config-graph-type>').change(this.handleChangeGraphType.bind(this))))
			this.appendFieldList(dialog)
			$('body').append(dialog)
			if(me.hasGraphs){
				Object.keys(graphTypes).forEach(function(graphType){
					var available = false
					for (var field in statInfo){
						if (me.graphTypeOk(field,graphType)){
							available=true
							break
						}
					}
					if (available)$('#stats-config-graph-type').append($('<option>').attr('value',graphType).text(translate(`graph_${graphType}`)))
				})
			}
		}
		$('#stats-config-section-name').val(section||"")
		var stats=me.getStatsConfig()[section]||(me.hasGraphs?{graph:"bar",data:[]}:{data:[]}),
		fields=stats.data
		if(me.hasGraphs)$('#stats-config-graph-type').val(stats.graph)
		me.populateFields(fields)
		applyTranslations(dialog)
		showLightBox(dialog)
		return false
	}

	removeSection(e){
		var section=$(e.target).attr('data-section')
		if (confirm(translate(this.hasGraphs?'remove_graph_confirm':'remove_section_confirm'))){
			var stats=this.getStatsConfig()
			delete stats[section]
			localStorage.setItem(this.statsConfigKey, JSON.stringify(stats))
			closeLightBox()
			this.drawFunction()
		}
		return false
	}

	populateFields(fields){
		$('#stats-config-fields').html("")
		fields.forEach(field=>this.addFieldToStatsConfig(field))
		this.populateAddFields()
	}

	addFieldToStatsConfig(field){
		$('#stats-config-fields').append(
			$('<li>')
			.attr('data-field',field)
			.text(" " + translate(field)).prepend(
				$('<button style=color:red>').text('✘').click(function(){
					$(this).closest('li').remove()
				})
			)
		)
	}

	populateAddFields(){
		var select=$('#stats-config-add-field'),
		config=this,
		types=config.hasGraphs? new Set(graphTypes[$('#stats-config-graph-type').val()].types):new Set(numericGraphTypes),
		statNames=Object.keys(statInfo)
		statNames.sort((a,b)=>translate(a).localeCompare(translate(b)))
		select.html("")
		select.append($('<option>').attr('value',"").attr('selected','true'))
		statNames.forEach(function(stat){
			var info=statInfo[stat]
			if (types.has(info.type) || (config.hasWhiteboard && info.whiteboard_end)){
				select.append($('<option>').attr('value',stat).text(`${translate(stat)} (${info.type})`))
			}
		})
	}

	setTeam(team){
		this.team=team
	}

	showConfigDialog(e){
		var section=$(e.target).attr('data-section'),
		dialog=$('#stats-config')
		if (!dialog.length){
			dialog=$('<div id=stats-config class=lightBoxCenterContent style=display:none>')
			if(this.hasSections){
				var sectionLinks=$('<ul>')
				if (this.hasGraphs && this.downloadBlobs)sectionLinks.append($('<li>').append($('<a id=download-data-link data-i18n=download_data_link></a>')))
				sectionLinks.append($('<li>').append($('<a class=needs-section-attr href=#edit data-i18n=edit_link></a>').click(this.showEditSectionDialog.bind(this))))
				.append($('<li>').append($('<a class=needs-section-attr href=#remove data-i18n=remove_link></a>').click(this.removeSection.bind(this))))
				dialog.append($('<h2 class=needs-section-text>'))
				.append(sectionLinks)
				.append($('<h2>').attr('data-i18n',this.hasGraphs?"manage_graphs_heading":"manage_stats_heading"))
			} else {
				this.appendFieldList(dialog)
			}
			var manageAllList = $('<ul>')
			if (this.hasSections)manageAllList.append($('<li>').append($(`<a href=#edit-json data-i18n=${this.hasGraphs?"add_graph_link":"add_section_link"}></a>`).click(this.showEditSectionDialog.bind(this))))

			manageAllList
			.append($('<li>').append($('<a href=#edit-json data-i18n=edit_json_link></a>').click(this.showExportDialog.bind(this))))
			.append($('<li>').append($('<a href=#save-server data-i18n=save_to_server_link></a>').click(this.saveToServer.bind(this))))
			.append($('<li>').append($('<a href=#revert-personal data-i18n=revert_personal_link></a>').click(this.revertPersonalCustomizations.bind(this))))
			.append($('<li>').append($('<a href=#revert-all data-i18n=revert_all_link></a>').click(this.revertAllCustomizations.bind(this))))
			dialog.append(manageAllList)
			$('body').append(dialog)
		}
		var stats=this.getStatsConfig()
		if(this.hasSections){
			stats=stats[section]||(this.hasGraphs?{graph:'bar',data:[]}:{data:[]})
			$('.needs-section-attr').attr('data-section',section)
			$('.needs-section-text').text(section)
		} else {
			this.populateFields(stats)
		}
		if (this.hasGraphs && this.downloadBlobs){
			$('#download-data-link').attr('href',
				window.URL.createObjectURL(this.downloadBlobs[section])
			).attr('download',
				`${eventId}.${this.team?this.team+".":""}${section.toLowerCase().replace(/[^a-zA-Z0-9 ]/,"").replace(" ","_")}.csv`
			)
		}
		applyTranslations(dialog)
		showLightBox(dialog)
	}
}
