<!DOCTYPE html>
<html>
<head>
<title>Whiteboard test</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel=stylesheet href=/main.css>
<link rel=stylesheet href=/local.css>
<script src=/jquery.min.js></script>
<script src=/main.js></script>
<script src=/local.js></script>
<link rel=icon type=image/png href=/logo.png>
<style>
#fieldDraw{width:40%;aspect-ratio:.5;background:url('/2024/field-whiteboard.png');background-size:100%;display:block;margin:0 auto}
</style>
<script>

class Whiteboard {
	constructor(canvas){
		this.canvas = canvas
		this.canvas.width=2000
		this.canvas.height=this.canvas.width/this.canvas.clientWidth*this.canvas.clientHeight
		this.maxDimension=Math.max(this.canvas.width,this.canvas.height)
		this.ctx = canvas.getContext('2d')
		document.addEventListener("mousemove",e=>this.moused.call(this,e),{passive:false})
		document.addEventListener("mousedown",e=>this.moused.call(this,e),{passive:false})
		document.addEventListener("mouseup",e=>this.moused.call(this,e),{passive:false})
		document.addEventListener("touchstart",e=>this.moused.call(this,e),{passive:false})
		document.addEventListener("touchend",e=>this.moused.call(this,e),{passive:false})
		document.addEventListener("touchcancel",e=>this.moused.call(this,e),{passive:false})
		document.addEventListener("touchmove",e=>this.moused.call(this,e),{passive:false})
		window.addEventListener("resize",e=>this.size.call(this),{passive:true})
		this.size()
		this.drawClear()
		this.penMode('#000')
		this.history=[]
	}

	stampMode(image){
		this.mode='stamp'
		this.canvas.style.cursor=`url('${image.src}'),cell`
		this.stampImage=image
	}

	penMode(color){
		this.color=color
		this.mode='pen'
		this.canvas.style.cursor="url('/pencil.svg'),crosshair"
	}

	eraserMode(){
		this.mode='eraser'
		this.canvas.style.cursor="url('/eraser.svg'),grab"
	}

	size(){
		this.width=this.canvas.clientWidth
		this.height=this.canvas.clientHeight
		this.left=this.canvas.getBoundingClientRect().left
		this.right=this.canvas.getBoundingClientRect().right
		this.top=this.canvas.getBoundingClientRect().top
		this.bottom=this.canvas.getBoundingClientRect().bottom
	}

	clear(){
		this.current=new ClearStroke()
		this.history.push(this.current)
		this.current.draw(this)
	}

	drawClear(){
		this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height)
	}

	undo(){
		this.history.pop()
		this.redraw()
	}

	redraw(){
		this.drawClear()
		for (var i=0; i<this.history.length; i++){
			this.history[i].draw(this)
		}
	}

	moused(e){
		var drawing = (e.buttons&1)==1||/^touchstart|touchmove$/.test(e.type)
		if ((this.current && this.current.mode != this.mode) || !drawing){
			this.current=null
			this.lastPoint=null
		}
		var touch=e.touches&&e.touches.length?e.touches[0]:{pageX:e.clientX||-1,pageY:e.clientY||[-1]},
		x=touch.pageX,
		y=touch.pageY,
		point=[
			Math.max(0,Math.min((x-this.left)*(this.canvas.width/this.width),this.canvas.width)),
			Math.max(0,Math.min((y-this.top)*(this.canvas.height/this.height),this.canvas.height))
		]
		if (x<this.left||y<this.top||x>this.right||y>this.bottom){
			if (x>=0&&y>=0&&!/^mouseup|mousedown$/.test(e.type)){
				if (this.current){
					this.current.addPoint(point)
					this.current.draw(this)
					this.current=null
				}
				this.lastPoint=point
			}
			return
		}
		e.preventDefault()
		if(!drawing)return
		if (!this.current){
			switch(this.mode){
				case "pen":
					this.current=new PenStroke(this.color)
					break
				case "eraser":
					this.current=new EraserStroke()
					break
				case "stamp":
					this.current=new StampStroke(this.stampImage)
					break
			}
			this.history.push(this.current)
		}
		this.current.addPoint(point,this.lastPoint)
		this.lastPoint=null
		this.current.draw(this)
	}
}

class WhiteboardStroke {
	constructor(){
		this.points=[]
		this.composite="source-over"
		this.lineScale=0.003
		this.maxPoints=99999
	}

	addPoint(point,prePoint){
		if (this.points.length>=this.maxPoints)return
		if (this.points.length&&(this.points[this.points.length-1][0]==point[0]&&this.points[this.points.length-1][1]==point[1]))return
		if (this.maxPoints>1&&prePoint)this.points.push(prePoint)
		this.points.push(point)
	}

	drawStart(whiteboard){
		whiteboard.ctx.beginPath()
		whiteboard.ctx.strokeStyle=this.color
		whiteboard.ctx.fillStyle=this.color
		whiteboard.ctx.globalCompositeOperation=this.composite
		whiteboard.ctx.lineWidth=whiteboard.maxDimension*this.lineScale
	}

	drawEnd(whiteboard){
		whiteboard.ctx.closePath()
	}
}

class PenStroke extends WhiteboardStroke {
	constructor(color){
		super()
		this.color=color
		this.mode="pen"
	}

	draw(whiteboard){
		this.drawStart(whiteboard)
		if(this.points.length){
			if(this.points.length==1){
				whiteboard.ctx.arc(this.points[0][0],this.points[0][1],whiteboard.ctx.lineWidth/2,0,2*Math.PI)
				whiteboard.ctx.fill()
			} else {
				whiteboard.ctx.moveTo(this.points[0][0],this.points[0][1])
				for(var i=1;i<this.points.length;i++){
					whiteboard.ctx.lineTo(this.points[i][0],this.points[i][1])
				}
				whiteboard.ctx.stroke()
			}
		}
		this.drawEnd(whiteboard)
	}
}

class EraserStroke extends PenStroke {
	constructor(color){
		super('#999')
		this.composite="destination-out"
		this.lineScale=0.03
		this.mode="eraser"
	}
}


class ClearStroke extends WhiteboardStroke {
	constructor(color){
		super()
		this.mode="clear"
		this.maxPoints=0
	}

	draw(whiteboard){
		whiteboard.drawClear()
	}
}

class StampStroke extends WhiteboardStroke {
	constructor(image){
		super()
		this.mode="stamp"
		this.image=image
		this.maxPoints=1
	}

	draw(whiteboard){
		var width=this.image.width,
		height=this.image.height,
		imageMax=Math.max(width,height),
		scale=whiteboard.maxDimension/imageMax*0.025
		whiteboard.ctx.drawImage(this.image,0,0,width,height,this.points[0][0],this.points[0][1],width*scale,height*scale)
	}
}

var whiteboard

$(document).ready(function(){
	whiteboard = new Whiteboard($('#fieldDraw')[0])

	$('.clear').click(()=>whiteboard.clear.call(whiteboard))
	$('.eraser').click(()=>whiteboard.eraserMode.call(whiteboard))
	$('.stamp').click(function(){whiteboard.stampMode.call(whiteboard,this.querySelector('img'))})
	$('.pen').click(function(){whiteboard.penMode.call(whiteboard,this.style.color)})
	$('.undo').click(()=>whiteboard.undo.call(whiteboard))
})
</script>
</head>
<body>
<canvas id=fieldDraw></canvas>
<br>

<div id=drawingControls>
	<button class="pen selected icon-button" style=color:black title="Whiteboard pen, black">‚¨§</button>
	<span id=stamps>
		<button class="stamp icon-button"><img src="/2023/cone-stamp.png"></button>
		<button class="stamp icon-button"><img src="/2023/cube-stamp.png"></button>
	</span>
	<button id=bot-0-pen class="pen icon-button" style=color:#C30072>‚¨§</button>
	<button id=bot-1-pen class="pen icon-button" style=color:#F50000>‚¨§</button>
	<button id=bot-2-pen class="pen icon-button" style=color:#F57100>‚¨§</button>
	<button id=bot-3-pen class="pen icon-button" style=color:#002FA4>‚¨§</button>
	<button id=bot-4-pen class="pen icon-button" style=color:#009393>‚¨§</button>
	<button id=bot-5-pen class="pen icon-button" style=color:#0AC600>‚¨§</button>
	<button class="eraser icon-button" title="Whiteboard eraser">‚óç</button>
	<button class="undo icon-button" title="Whiteboard undo">‚Ü∂</button>
	<button class="clear icon-button" title="Whiteboard clear">‚úò</button>
	<button class="rotate icon-button" title="Whiteboard rotate">üóò</button>
	<button class="printer icon-button" title="Print, save page">üñ∂</button>
	<button class="clear-teams icon-button" title="Choose teams">‚ñ¶</button>
	<button class="configure-stats icon-button" title="Configure stats">‚öô</button>
	<button class="showInstructions icon-button" title="Show instructions">?</button>
</div>
</body>
</html>
