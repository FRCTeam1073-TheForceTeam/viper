"use strict"

addI18n({
	score_label:{
		en:'Score:',
		tr:'Puan:',
		pt:'Pontuação:',
		fr:'Score :',
		he:'צִיוּן:',
		zh_tw:'分數：',
	},
	scouted_label:{
		en:'Scouted:',
		tr:'İzlenen:',
		pt:'Observado:',
		fr:'Scruté :',
		he:'צופי:',
		zh_tw:'偵察：',
	},
	prediction_label:{
		en:'Predicted:',
		tr:'Tahmin edilen:',
		pt:'Previsto:',
		fr:'Prévu :',
		he:'חזוי:',
		zh_tw:'預測：',
	},
	history_link:{
		en:'History',
		pt:'Histórico',
		he:'הִיסטוֹרִיָה',
		tr:'Geçmiş',
		fr:'Historique',
		zh_tw:'歷史',
	},
	download_link:{
		en:'Download',
		pt:'Download',
		he:'הורד',
		tr:'İndir',
		fr:'Télécharger',
		zh_tw:'下載',
	},
	file_view_link:{
		en:'View',
		pt:'Visualizar',
		he:'נוֹף',
		tr:'Görüntüle',
		fr:'Afficher',
		zh_tw:'看法',
	},
	date_range:{
		en:"_START_ to _END_",
		pt:'_START_ a _END_',
		he:'_START_ אל _END_',
		tr:'_START_ ile _END_',
		fr:'_START_ à _END_',
		zh_tw:'_START_ 至 _END_',
	},
	scouting_heading:{
		en:'Scouting',
		he:'צוֹפִיוּת',
		zh_tw:'偵察',
		pt:'Scouting',
		fr:'Repérage',
		tr:'İzcilik',
	},
	event_upload_link:{
		en:'Upload Scouting Data (Matches: _UPLOADCOUNT_)',
		he:'העלה נתוני צופים (התאמות: _UPLOADCOUNT_)',
		zh_tw:'上傳偵察資料（匹配數：_UPLOADCOUNT_）',
		pt:'Carregar dados de Scouting (Partidas: _UPLOADCOUNT_)',
		fr:'Télécharger les données de repérage (Matchs : _UPLOADCOUNT_)',
		tr:'İzcilik Verilerini Yükle (Maçlar: _UPLOADCOUNT_)',
	},
	scout_match_link:{
		en:'Scout a match',
		he:'צופי גפרור',
		zh_tw:'偵察比賽',
		pt:'Observar uma partida',
		fr:'Repérer un match',
		tr:'Bir maçı izle',
	},
	all_photos_link:{
		en:'Upload bot photos for all teams',
		he:'העלה תמונות בוט לכל הקבוצות',
		zh_tw:'為所有隊伍上傳機器人照片',
		pt:'Carregar fotos de bot para todos os times',
		fr:'Télécharger les photos du robot pour toutes les équipes',
		tr:'Tüm takımlar için bot fotoğrafları yükle',
	},
	all_pit_link:{
		en:'Open pit scouting for all teams',
		zh_tw:'為所有團隊進行露天礦場勘察',
		pt:'Observação de poço aberto para todos os times',
		fr:'Repérage en fosse ouverte pour toutes les équipes',
		tr:'Tüm takımlar için açık çukur izciliği',
		he:'',
	},
	pit_squads:{
		en:'Open pit and photo scouting squads:',
		he:'חוליות בור פתוח וצופית צילום:',
		zh_tw:'露天礦和攝影偵察隊：',
		pt:'Esquadrões de observação de poço aberto e de fotos:',
		fr:'Repérage en fosse ouverte et photos des équipes :',
		tr:'Açık çukur ve fotoğraf izcilik takımları:',
	},
	all_subjective_link:{
		en:'Subjective scouting',
		he:'סקאוטינג סובייקטיבי',
		zh_tw:'主觀球探',
		pt:'Observação subjetiva',
		fr:'Repérage subjectif',
		tr:'Öznel izcilik',
	},
	top_scouters_link:{
		en:'Top scouters',
		he:'צופים מובילים',
		zh_tw:'頂級球探',
		pt:'Melhores olheiros',
		fr:'Meilleurs recruteurs',
		tr:'En iyi izciler',
	},
	compare_link:{
		en:'Compare scouting to official scores',
		he:'השווה את הסקאוטינג לתוצאות רשמיות',
		zh_tw:'將球探調查結果與官方分數進行比較',
		pt:'Comparar observação com pontuações oficiais',
		fr:'Comparer les résultats du repérage aux scores officiels',
		tr:'İzciliği resmi skorlarla karşılaştır',
	},
	strategy_heading:{
		en:'Strategy',
		he:'אִסטרָטֶגִיָה',
		zh_tw:'策略',
		pt:'Estratégia',
		fr:'Stratégie',
		tr:'Strateji',
	},
	event_stats_link:{
		en:'View stats for alliance selection',
		he:'הצג נתונים סטטיסטיים עבור בחירת ברית',
		zh_tw:'查看聯盟選擇的統計數據',
		pt:'Ver estatísticas para seleção de alianças',
		fr:'Afficher les statistiques pour la sélection d\'alliance',
		tr:'İttifak seçimi için istatistikleri görüntüle',
	},
	all_predict_link:{
		en:'Predict a match outcome',
		he:'חזה את תוצאת המשחק',
		zh_tw:'預測比賽結果',
		pt:'Prever o resultado de uma partida',
		fr:'Prédire l\'issue d\'un match',
		tr:'Bir maç sonucunu tahmin et',
	},
	all_planner_link:{
		en:'View match planner with whiteboard',
		he:'צפה במתכנן התאמה עם לוח לבן',
		zh_tw:'使用白板查看比賽計劃器',
		pt:'Ver planejador de partidas com quadro branco',
		fr:'Afficher le planificateur de match avec le tableau blanc',
		tr:'Beyaz tahta ile maç planlayıcısını görüntüle',
	},
	all_team_stats_link:{
		en:'View individual team stats and pit scouting data',
		he:'הצג נתונים סטטיסטיים של צוות בודד ונתוני סקאוטינג בבור',
		zh_tw:'查看各車隊的統計數據和維修站偵察數據',
		pt:'Ver estatísticas de times individuais e dados de observação de poço',
		fr:'Afficher les statistiques individuelles des équipes et les données de repérage en fosse',
		tr:'Bireysel takım istatistiklerini ve çukur izcilik verilerini görüntüle',
	},
	data_heading:{
		en:'Data',
		he:'נְתוּנִים',
		zh_tw:'數據',
		pt:'Dados',
		fr:'Données',
		tr:'Veri',
	},
	viper_export_link:{
		en:'Export to another Viper',
		he:'ייצוא לצפע אחר',
		zh_tw:'匯出至另一個 Viper',
		pt:'Exportar para outro Viper',
		fr:'Exporter vers un autre Viper',
		tr:'Başka bir Viper\'a aktar',
	},
	computed_data_link:{
		en:'Scouting Data with Computed Scores',
		he:'נתוני צופי עם ציונים מחושבים',
		zh_tw:'使用計算分數來偵察數據',
		pt:'Dados de observação com pontuações computadas',
		fr:'Données de repérage avec scores calculés',
		tr:'Hesaplanmış Skorlarla İzcilik Verileri',
	},
	aggregated_data_link:{
		en:'Scouting Data Aggregated by Team',
		he:'נתוני צופי מצטברים לפי צוות',
		zh_tw:'按球隊彙總的球探數據',
		pt:'Dados de observação agregados por time',
		fr:'Données de repérage agrégées par équipe',
		tr:'Takım Tarafından Toplanan İzcilik Verileri',
	},
	edit_event_heading:{
		en:'Edit Event',
		he:'ערוך אירוע',
		zh_tw:'編輯活動',
		pt:'Editar evento',
		fr:'Modifier l\'événement',
		tr:'Etkinliği Düzenle',
	},
	edit_event_link:{
		en:'Change event details and match schedule',
		he:'שנה את פרטי האירוע ולוח הזמנים של המשחק',
		zh_tw:'更改賽事詳情和比賽行程',
		pt:'Alterar detalhes do evento e cronograma de partidas',
		fr:'Modifier les détails de l\'événement et le calendrier des matchs',
		tr:'Etkinlik ayrıntılarını ve maç programını değiştir',
	},
	edit_playoffs_link:{
		en:'Input alliance selection results and playoff type',
		he:'הזן תוצאות בחירת ברית וסוג פלייאוף',
		zh_tw:'輸入聯盟選擇結果和季後賽類型',
		pt:'Inserir resultados de seleção de alianças e tipo de playoff',
		fr:'Saisir les résultats de la sélection d\'alliance et le type de séries éliminatoires',
		tr:'İttifak seçimi sonuçlarını ve playoff türünü gir',
	},
	api_link:{
		en:'Fetch latest schedule and official scores from the FIRST API',
		he:'קבל את לוח הזמנים העדכני ביותר וציונים רשמיים מה-FIRST API',
		zh_tw:'從 FIRST API 取得最新賽程和官方成績',
		pt:'Obter a programação mais recente e pontuações oficiais da API FIRST',
		fr:'Récupérer le calendrier et les scores officiels les plus récents depuis l\'API FIRST',
		tr:'FIRST API\'den en son programı ve resmi skorları al',
	},
	import_link:{
		en:'Import data from another app',
		he:'ייבא נתונים מאפליקציה אחרת',
		zh_tw:'從其他應用程式匯入數據',
		pt:'Importar dados de outro aplicativo',
		fr:'Importer des données depuis une autre application',
		tr:'Başka bir uygulamadan veri içe aktar',
	},
	external_links_heading:{
		en:'External Links',
		he:'קישורים חיצוניים',
		zh_tw:'外部連結',
		pt:'Links externos',
		fr:'Liens externes',
		tr:'Harici Bağlantılar',
	},
	blue_alliance_main_link:{
		en:'The Blue Alliance',
		he:'הברית הכחולה',
		zh_tw:'藍色聯盟',
		pt:'A Aliança Azul',
		fr:'L\'Alliance Bleue',
		tr:'The Blue Alliance',
	},
	blue_alliance_results_link:{
		en:'Results',
		he:'תוצאות',
		zh_tw:'結果',
		pt:'Resultados',
		fr:'Résultats',
		tr:'Sonuçlar',
	},
	blue_alliance_rankings_link:{
		en:'Rankings',
		he:'דירוגים',
		zh_tw:'排名',
		pt:'Classificações',
		fr:'Classements',
		tr:'Sıralamalar',
	},
	blue_alliance_awards_link:{
		en:'Awards',
		he:'פרסים',
		zh_tw:'獎項',
		pt:'Prêmios',
		fr:'Récompenses',
		tr:'Ödüller',
	},
	blue_alliance_district_link:{
		en:'District Points',
		he:'נקודות מחוז',
		zh_tw:'地區積分',
		pt:'Distrito Pontos',
		fr:'District Points',
		tr:'Bölge Puanları',
	},
	blue_alliance_teams_link:{
		en:'Teams',
		he:'צוותים',
		zh_tw:'團隊',
		pt:'Equipes',
		fr:'Équipes',
		tr:'Takımlar',
	},
	blue_alliance_insights_link:{
		en:'Insights',
		he:'תובנות',
		zh_tw:'洞察',
		pt:'Insights',
		fr:'Informations',
		tr:'Görüşler',
	},
	blue_alliance_media_link:{
		en:'Media',
		he:'כְּלֵי תִקְשׁוֹרֶת',
		zh_tw:'媒體',
		pt:'Mídia',
		fr:'Médias',
		tr:'Medya',
	},
	orange_alliance_main_link:{
		en:'The Orange Alliance',
		he:'הברית הכתומה',
		zh_tw:'橘色聯盟',
		pt:'A Orange Alliance',
		fr:'L\'Alliance Orange',
		tr:'The Orange Alliance',
	},
	first_main_link:{
		en:'First Inspires',
		he:'השראה ראשונה',
		zh_tw:'首次啟發',
		pt:'First Inspires',
		fr:'Inspirations',
		tr:'First Inspires',
	},
	first_practice_link:{
		en:'Practice Matches',
		he:'תרגול התאמות',
		zh_tw:'練習賽',
		pt:'Partidas de treino',
		fr:'Matchs d\'entraînement',
		tr:'Practice Matchs',
	},
	first_matches_link:{
		en:'Qualification Matches',
		he:'משחקי הסמכה',
		zh_tw:'資格賽',
		pt:'Partidas de qualificação',
		fr:'Matchs de qualification',
		tr:'Kalifikasyon Maçları',
	},
	first_ranking_link:{
		en:'Qualification Rankings',
		he:'דירוג ההסמכה',
		zh_tw:'資格排名',
		pt:'Classificações de qualificação',
		fr:'Classements de qualification',
		tr:'Kalifikasyon Sıralamaları',
	},
	first_playoffs_link:{
		en:'Playoff Matches',
		he:'משחקי פלייאוף',
		zh_tw:'季後賽',
		pt:'Partidas de playoff',
		fr:'Matchs de séries éliminatoires',
		tr:'Playoff Maçları',
	},
	first_awards_link:{
		en:'Awards',
		he:'פרסים',
		zh_tw:'獎項',
		pt:'Prêmios',
		fr:'Récompenses',
		tr:'Ödüller',
	},
	show_advanced_link:{
		en:'Show advanced options',
		he:'הצג אפשרויות מתקדמות',
		zh_tw:'顯示進階選項',
		pt:'Mostrar opções avançadas',
		fr:'Afficher les options avancées',
		tr:'Gelişmiş seçenekleri göster',
	},
	score_abbreviation:{
		en:'Scr',
		he:'צִיוּן',
		zh_tw:'分數',
		pt:'Pontuação',
		fr:'Score',
		tr:'Skor',
	},
	csv_event:{
		en:'Event Info CSV',
		he:'CSV פרטי אירוע',
		zh_tw:'活動資訊 CSV',
		pt:'Informações do evento CSV',
		fr:'Infos événement (CSV)',
		tr:'Etkinlik Bilgileri CSV',
	},
	csv_schedule:{
		en:'Schedule CSV',
		he:'תזמן CSV',
		zh_tw:'計劃 CSV',
		pt:'Cronograma CSV',
		fr:'Calendrier (CSV)',
		tr:'Program CSV',
	},
	csv_scouting:{
		en:'Scouting CSV',
		he:'צופי CSV',
		zh_tw:'偵察 CSV',
		pt:'Olheiros CSV',
		fr:'Repérage (CSV)',
		tr:'İzleme CSV',
	},
	json_alliances:{
		en:'API Alliances',
		tr:'API İttifakları',
		pt:'Alianças de API',
		fr:'Alliances API',
		he:'בריתות API',
		zh_tw:'API 聯盟',
	},
	csv_alliances:{
		en:'Alliances CSV',
		he:'CSV של בריתות',
		zh_tw:'聯盟 CSV',
		pt:'Alianças CSV',
		fr:'Alliances (CSV)',
		tr:'İttifaklar CSV',
	},
	csv_pit:{
		en:'Pit Scouting CSV',
		he:'צופי בור CSV',
		zh_tw:'坑道偵察 CSV',
		pt:'Olheiros de box CSV',
		fr:'Repérage des stands',
		tr:'Pit İzciliği',
	},
	csv_subjective:{
		en:'Subjective Scouting CSV',
		he:'צופי סובייקטיבי CSV',
		zh_tw:'主觀球探 CSV',
		pt:'Olheiros Subjetivos CSV',
		fr:'Repérage subjectif (CSV)',
		tr:'Subjektif İzcilik CSV',
	},
	json_info:{
		en:'API Event Info JSON',
		he:'פרטי אירוע API JSON',
		zh_tw:'API 事件資訊 JSON',
		pt:'API Informações do evento JSON',
		fr:'Infos événement (JSON) API',
		tr:'API Etkinlik Bilgileri JSON',
	},
	json_teams:{
		en:'API Team List JSON',
		he:'רשימת צוות API JSON',
		zh_tw:'API 團隊清單 JSON',
		pt:'API Lista de equipes JSON',
		fr:'Liste des équipes (JSON) API',
		tr:'API Takım Listesi JSON',
	},
	json_schedule_practice:{
		en:'API Practice Schedule JSON',
		he:'לוח זמנים לתרגול API JSON',
		zh_tw:'API 團隊清單 JSON',
		pt:'API Cronograma de treino JSON',
		fr:'Calendrier d\'entraînement (JSON) API',
		tr:'API Antrenman Programı JSON',
	},
	json_schedule_qualification:{
		en:'API Qualification Schedule JSON',
		he:'לוח זמנים להסמכת API JSON',
		zh_tw:'API 資格計劃 JSON',
		pt:'API Cronograma de qualificação JSON',
		fr:'Calendrier de qualification (JSON) API',
		tr:'API Kalifikasyon Programı JSON',
	},
	json_schedule_playoff:{
		en:'API Playoff Schedule JSON',
		he:'לוח זמנים לפלייאוף API JSON',
		zh_tw:'API 季後賽行程表 JSON',
		pt:'API Cronograma de playoff JSON',
		fr:'Calendrier des séries éliminatoires (JSON) API',
		tr:'API Playoff Programı JSON',
	},
	json_scores_qualification:{
		en:'API Qualification Scores JSON',
		he:'ציוני הסמכה של API JSON',
		zh_tw:'API 資格分數 JSON',
		pt:'API Pontuações de qualificação JSON',
		fr:'Scores de qualification (JSON) API',
		tr:'API Kalifikasyon Puanları JSON',
	},
	json_scores_playoff:{
		en:'API Playoff Scores JSON',
		he:'ציוני פלייאוף API JSON',
		zh_tw:'API 季後賽比分 JSON',
		pt:'API Pontuações de playoff JSON',
		fr:'Scores des séries éliminatoires (JSON) API',
		tr:'API Playoff Puanları JSON',
	},
	team_num_header:{
		en:'Team _TEAMID_',
		he:'צוות _TEAMID_',
		zh_tw:'團隊 _TEAMID_',
		pt:'Equipe _TEAMID_',
		fr:'Équipe _TEAMID_',
		tr:'Takım _TEAMID_',
	},
	scout_this_match_link:{
		en:'Scout',
		he:'לְגַשֵׁשׁ',
		zh_tw:'偵察',
		pt:'Olheiro',
		fr:'Repérage',
		tr:'İzci',
	},
	team_stats_header:{
		en:'Team stats:',
		he:'נתונים סטטיסטיים של הקבוצה:',
		zh_tw:'球隊數據：',
		pt:'Estatísticas da equipe:',
		fr:'Statistiques équipe :',
		tr:'Takım istatistikleri:',
	},
	team_stats_view_link:{
		en:'View',
		he:'נוֹף',
		zh_tw:'看法',
		pt:'Exibir',
		fr:'Voir',
		tr:'Görüntüle',
	},
	pit_scout_header:{
		en:'Pit scouting:',
		he:'סיור בורות:',
		zh_tw:'探坑：',
		pt:'Olheiros de box:',
		fr:'Repérage des stands :',
		tr:'Pit izciliği:',
	},
	pit_scout_view_link:{
		en:'View',
		he:'נוֹף',
		zh_tw:'看法',
		pt:'Exibir',
		fr:'Voir',
		tr:'Görüntüle',
	},
	pit_scout_collect_link:{
		en:'Collect data',
		he:'איסוף נתונים',
		zh_tw:'收集數據',
		pt:'Coletar dados',
		fr:'Collecter des données',
		tr:'Topla veri',
	},
	subjective_header:{
		en:'Subjective scouting:',
		he:'סקאוטינג סובייקטיבי:',
		zh_tw:'主觀偵察：',
		pt:'Olheiros subjetivos:',
		fr:'Repérage subjectif :',
		tr:'Öznel izcilik:',
	},
	subjective_view_link:{
		en:'View',
		he:'נוֹף',
		zh_tw:'看法',
		pt:'Exibir',
		fr:'Voir',
		tr:'Görüntüle',
	},
	subjective_collect_link:{
		en:'Collect data',
		he:'איסוף נתונים',
		zh_tw:'收集數據',
		pt:'Coletar dados',
		fr:'Collecter des données',
		tr:'Veri topla',
	},
	predict_link:{
		en:'Predict match outcome',
		he:'חזה את תוצאת המשחק',
		zh_tw:'預測比賽結果',
		pt:'Prever o resultado da partida',
		fr:'Prédire le résultat du match',
		tr:'Maç sonucunu tahmin et',
	},
	planner_link:{
		en:'View planner and whiteboard',
		he:'צפה במתכנן ובלוח',
		zh_tw:'查看計劃器和白板',
		pt:'Exibir planejador e quadro branco',
		fr:'Voir le planificateur et le tableau blanc',
		tr:'Planlayıcıyı ve beyaz tahtayı görüntüle',
	},
	score_header_official:{
		en:'Official Score',
		he:'ציון רשמי',
		zh_tw:'官方成績',
		pt:'Oficial Pontuação',
		fr:'Score officiel',
		tr:'Resmi Skor',
	},
	score_header_scouted:{
		en:'Scouted Score',
		he:'ציון צופי',
		zh_tw:'球探評分',
		pt:'Pontuação observada',
		fr:'Repérage Score',
		tr:'İzlenen Skor',
	},
	score_header_predicted:{
		en:'Predicted Score',
		he:'ציון חזוי',
		zh_tw:'預測得分',
		pt:'Pontuação prevista',
		fr:'Score prévu',
		tr:'Tahmin Edilen Skor',
	},
	aggregation_includes_practice:{
		en:'* Aggregation includes practice matches',
		he:'* צבירה כוללת משחקי אימון',
		pt:'* Agregação inclui partidas de treino',
		tr:'* Toplama, antrenman maçlarını içerir',
		zh_tw:'* 總結包括練習賽',
		fr:'* L\'agrégation inclut les matchs d\'entraînement',
	},
	aggregation_excludes_practice:{
		en:'* Aggregation excludes practice matches',
		he:'* צבירה לא כוללת משחקי אימון',
		pt:'* Agregação exclui partidas de treino',
		tr:'* Toplama, antrenman maçlarını hariç tutar',
		zh_tw:'* 總結不包括練習賽',
		fr:'* L\'agrégation exclut les matchs d\'entraînement',
	},
})

var extensionMap={},
fileList=[]
onApplyTranslation.push(function(){
	extensionMap = {
		"event.csv":['dependInfo',translate('csv_event')],
		"schedule.csv":['dependSchedule',translate('csv_schedule')],
		"scouting.csv":['dependScouting',translate('csv_scouting')],
		"alliances.csv":['dependAlliances',translate('csv_alliances')],
		"pit.csv":['dependPit',translate('csv_pit')],
		"subjective.csv":['dependSubjective',translate('csv_subjective')],
		"info.json":['',translate('json_info')],
		"teams.json":['',translate('json_teams')],
		"schedule.practice.json":['',translate('json_schedule_practice')],
		"schedule.qualification.json":['',translate('json_schedule_qualification')],
		"schedule.playoff.json":['',translate('json_schedule_playoff')],
		"scores.qualification.json":['dependScores',translate('json_scores_qualification')],
		"scores.playoff.json":['dependScores',translate('json_scores_playoff')],
		"alliances.json":['dependAlliances',translate('json_alliances')],
	}
	fileList.forEach(file=>{
		var extension = file.replace(/[^\.]+\./,"").replace(/\.[0-9]+\./,"."),
		title = extension,
		fileNum = (file.match(/\.([0-9])+\./)||['',''])[1]
		if (extensionMap[extension])title = extensionMap[extension][1]
		title+=fileNum?(" "+fileNum):""
		$(`a[href="${file}"]`).text(title)
	})
	$('[data-match-id]').each(function(){
		$(this).text(getShortMatchName($(this).attr('data-match-id')))
	})
})

$(document).ready(function(){
	if (!eventYear || !eventVenue) return showError('Event Not Specified')
	if ("ftc"==eventCompetition) $('.noftc').hide()
	var uploadCount = getUploads().length
	$('.initHid').hide()

	function showDataActions(){
		var url = $(this).attr('href'),
		da = $('#dataActions'),
		file = url.replace(/.*\//,""),
		list = da.find('ul').html(""),
		download = $('<a data-i18n=download_link>').attr('href',url)
		da.find('h2').text($(this).attr('download')?$(this).attr('download'):file)
		if ($(this).attr('download')) download.attr('download', $(this).attr('download'))
		list.append($('<li>').append(download))
		if (/\.csv/.test(file)){
			list.append($('<li>').append($('<a data-i18n=edit_link>').attr('href',`/edit.html#file=${file}`)))
			list.append($('<li>').append($('<a data-i18n=history_link>').attr('href',`/revisions.html#file=${file}`)))
		}
		if (/\.json/.test(file)){
			list.append($('<li>').append($('<a data-i18n=file_view_link>').attr('href',url).click(viewJson)))
		}
		if (/^blob/.test(url)){
			list.append($('<li>').append($('<a data-i18n=file_view_link>').attr('href',url).attr('data-source',$(this).attr('data-source')).click(viewDataAsTable)))
		}
		showLightBox(da)
		return false
	}
	$('.show-more').click(function(){
		$('.more').show()
		$(this).hide()

	})
	function setName(){
		$('title,h1').text(eventName)
	}
	function toDisplayDate(d){
		if (!d) return ""
		try {
			var b = d.split(/\D/),
			date = new Date(b[0], b[1]-1, b[2]),
			locale=translate('date_locale')
			if(!/^[a-z]{2}-[A-Z]{2}/.test(locale))locale='en-US'
			return new Intl.DateTimeFormat(locale,{dateStyle:'full'}).format(date)
		} catch (x){
			console.error("Could not parse",d,x)
			return ""
		}
	}

	function replaceVariables(){
		addTranslationContext({
			year:eventYear,
			event:eventId,
			uploadCount:uploadCount,
		})
		$('a').each(function(){
			$(this).attr(
				'href',$(this).attr('href')
				.replace('_YEAR_', eventYear)
				.replace('_EVENT_', eventId)
				.replace('_UPLOADCOUNT_', uploadCount)
			)
		})
	}

	replaceVariables()
	onApplyTranslation.push(replaceVariables)

	if (uploadCount) dependencySatisfied('dependUploads')

	function dependencySatisfied(depend){
		$(`.${depend}`).each(function(){
			$(this).removeClass(depend)
			var dependCount = 0
			$(this).attr('class').split(/ /).forEach(c=> {
				if (/^depend/.test(c)) dependCount++
			})
			if (dependCount == 0){
				$(this).show().removeClass('initHid').parents('.initHid').show().removeClass('initHid')
			}
		})
	}

	function matchScoutingDataCount(eventStatsByMatchTeam, m){
		if (!m) return false
		return BOT_POSITIONS.reduce((sum,pos)=>sum+(eventStatsByMatchTeam[`${m.Match}-${m[pos]}`]?1:0),0)
	}
	Promise.all([
		promiseEventMatches(),
		promiseEventStats(),
		promiseEventScores(),
		promiseEventFiles(),
		promiseEventInfo(),
		promiseSubjectiveScouting(),
		promisePitScouting(),
		promiseTeamsInfo(),
		fetch(`/season-files.cgi?season=${eventYear}`).then(response=>response.text()),
	]).then(values =>{
		[window.eventMatches, [window.eventStats, window.eventStatsByTeam, window.eventStatsByMatchTeam], window.eventScores, window.fileList, window.eventInfo, window.subjectiveData, window.pitData, window.eventTeamsInfo, window.seasonFiles] = values
		var lastDone,
		nextToScout,
		lastMatch,
		lastFullyDone,
		ourNext,
		haveScouting=false
		if (!fileList.length) return showError('Event Not Found')
		if (window.importFunctions&&Object.keys(window.importFunctions).length) dependencySatisfied('dependImport')
		fileList.forEach(file=>{
			var extension = file.replace(/[^\.]+\./,"").replace(/\.[0-9]+\./,".")
			if (extensionMap[extension]){
				var depend = extensionMap[extension][0]
				if (depend) dependencySatisfied(depend)
			}
			if(extension=='scouting.csv')haveScouting=true
			if (extension!="jpg") $('#dataList').append($('<li>').append($('<a>').attr('href',file).click(showDataActions))).parents('.initHid').show()
		})
		if(!haveScouting)$('#scout-link').after($('#photo-scout-link,#pit-scout-link'))
		seasonFiles.split(/[\r\n]+/).forEach(file=>{
			if (/\/subjective-scout\.html$/.test(file)) dependencySatisfied('dependSubjective')
			if (/\/pit-scout\.html$/.test(file)) dependencySatisfied('dependPit')
			if (/\/field-whiteboard\.png$/.test(file))dependencySatisfied('dependWhiteboard')
		})
		setName()
		if (eventInfo['blue_alliance_id']) blueAllianceId = eventInfo['blue_alliance_id']
		if (eventInfo['orange_alliance_id']) orangeAllianceId = eventInfo['orange_alliance_id']
		if (eventInfo['first_inspires_id']) firstInspiresId = eventInfo['first_inspires_id']
		if ("frc"==eventCompetition && /^20[0-9]{2}[a-z0-9]+/.test(blueAllianceId)) dependencySatisfied('dependBlueAlliance')
		if ("ftc"==eventCompetition && /^[0-9]{4}[A-Za-z0-9\-]+/.test(orangeAllianceId)) dependencySatisfied('dependOrangeAlliance')
		if ("frc"==eventCompetition && /^20[0-9]{2}\/?[A-Za-z0-9]+/.test(firstInspiresId)) dependencySatisfied('dependFirstFrc')
		if ("ftc"==eventCompetition && /^20[0-9]{2}\/?[A-Za-z0-9]+/.test(firstInspiresId)) dependencySatisfied('dependFirstFtc')
		$('a').each(function(){
			$(this).attr(
				'href',$(this).attr('href')
				.replace('_FIID_', firstInspiresId)
				.replace('_BAID_', blueAllianceId)
				.replace('_OAID_', orangeAllianceId)
			)
		})
		var info = $('#eventInfo').html('')
		if (eventInfo.location) info.append($('<div>').text(eventInfo.location))
		if (eventInfo.start || eventInfo.end){
			var start = eventInfo.start || eventInfo.end,
			end = eventInfo.end || eventInfo.start
			if (start != end){
				start = toDisplayDate(start)
				end = toDisplayDate(end)
				info.append($('<div data-i18n=date_range>').attr('data-start',start).attr('data-end',end))
			} else {
				start = toDisplayDate(start)
				info.append($('<div>').text(`${start}`))
			}
		}

		for (var i=eventMatches.length-1; !lastFullyDone && i>=0; i--){
			var m=eventMatches[i]
			if(matchScoutingDataCount(eventStatsByMatchTeam,m)==6)lastFullyDone=m
			if(!lastDone&&matchScoutingDataCount(eventStatsByMatchTeam,m))lastDone=m
			if(!lastDone&&matchHasTeam(m,getLocalTeam()))ourNext=m
			if(!lastDone&&!matchScoutingDataCount(eventStatsByMatchTeam,m))nextToScout=m
			if(!lastMatch)lastMatch=m
		}
		if((!nextToScout||!/^(pm|qm)/.test(nextToScout.Match))&&lastMatch){
			$('#edit-event-section').prepend($('#edit-event-header'))
			$('#edit-event-section>ul').append($('#edit-playoffs-link'))
		}
		if(!lastMatch||lastMatch&&/^pm/.test(lastMatch.Match)){
			$('#edit-event-section').prepend($('#edit-event-header'))
			$('#edit-event-section>ul').append($('#edit-match-link,.fetch-api-link'))
		}
		function getTeamInfo(teamNum){
			var info=eventTeamsInfo[teamNum]
			if (!info)return""
			var name=info.nameShort||""
			if (info.city)name+=`, ${info.city}`
			if (info.stateProv)name+=`, ${info.stateProv}`
			if (info.country)name+=`, ${info.country}`
			return name
		}
		var seenOurNext = false,
		seenLastFullyDone = false
		eventMatches.forEach(match=>{
			if(ourNext && ourNext.Match==match.Match) seenOurNext=true
			if(lastFullyDone && lastFullyDone.Match==match.Match) seenLastFullyDone=true
			var row = $($('template#matchRow').html()),
			redPrediction = 0, bluePrediction=0,
			redScouting = 0, blueScouting=0,
			isRedScouted = true, isBlueScouted = true
			if ("ftc"==eventCompetition) row.find('.noftc').hide()
			BOT_POSITIONS.forEach(pos=>{
				var scouted=eventStatsByMatchTeam[`${match.Match}-${match[pos]}`]||0,
				isScouted=((typeof scouted.score)!=='undefined')
				if(/^R/.test(pos)){
					if (!isScouted){
						isRedScouted=false
					} else {
						redScouting += scouted.score
					}
					redPrediction += getScore(eventStatsByTeam, match[pos])
				} else {
					if (!isScouted){
						isBlueScouted=false
					} else {
						blueScouting += scouted.score
					}
					bluePrediction += getScore(eventStatsByTeam, match[pos])
				}
				row.find(`.${pos}`).text(match[pos])
					.toggleClass("scouted",isScouted)
					.toggleClass("needed",(!isScouted)&&seenLastFullyDone&&!seenOurNext&&matchHasTeam(ourNext,match[pos]))
					.toggleClass("error",!!scouted&&!!scouted.old&&(typeof scouted.old.score)!=='undefined')
					.toggleClass("ourTeam",""+match[pos]==""+getLocalTeam())
					.toggleClass("tooltip-before",/^B/.test(pos))
					.attr('data-tooltip',getTeamInfo(match[pos])||null)
			})
			redPrediction=Math.round(redPrediction)
			bluePrediction=Math.round(bluePrediction)
			var hasScores = !!eventScores[match.Match],
			redScore=0, blueScore=0
			if (hasScores){
				eventScores[match.Match].alliances.forEach(function(alliance){
					if (alliance.alliance == "Blue"){
						blueScore = alliance.totalPoints
					} else {
						redScore = alliance.totalPoints
					}
				})
			}
			var redPoints=hasScores?redScore:(isRedScouted?redScouting:redPrediction),
			bluePoints=hasScores?blueScore:(isBlueScouted?blueScouting:bluePrediction),
			redTooltip=(hasScores?`${translate('score_label')} ${redScore}\n`:"")+(isRedScouted?`${translate('scouted_label')} ${redScouting}\n`:"")+`${translate('prediction_label')} ${redPrediction}`,
			blueTooltip=(hasScores?`${translate('score_label')} ${blueScore}\n`:"")+(isBlueScouted?`${translate('scouted_label')} ${blueScouting}\n`:"")+`${translate('prediction_label')} ${bluePrediction}`
			row.find('.redScore').addClass(hasScores?'score':(isRedScouted?'scouted':'prediction')).toggleClass('winner',redPoints>bluePoints).text(redPoints).attr('data-tooltip',redTooltip).attr('data-score',hasScores?redScore:"").attr('data-scouted',isRedScouted?redScouting:"").attr('data-prediction',redPrediction)
			row.find('.blueScore').addClass(hasScores?'score':(isBlueScouted?'scouted':'prediction')).toggleClass('winner',redPoints<bluePoints).text(bluePoints).attr('data-tooltip',blueTooltip).attr('data-score',hasScores?blueScore:"").attr('data-scouted',isBlueScouted?blueScouting:"").attr('data-prediction',bluePrediction).addClass('tooltip-before')
			row.find('.match-id').text(getShortMatchName(match.Match)).attr('data-match-id',match.Match)
			row.click(showLinks)
			$('#matches').append(row)
		})
		window.eventStats = eventStats
		$('#extendedScoutingData')
			.attr('href', window.URL.createObjectURL(new Blob([excelCsv(eventStats)], {type: 'text/csv;charset=utf-8'})))
			.attr('download',`${eventId}.scouting.extended.csv`)
			.attr('data-source','eventStats')
			.click(showDataActions)
		window.eventStatsByTeam = eventStatsByTeam
		$('#aggregatedScoutingData')
			.attr('href', window.URL.createObjectURL(new Blob([excelCsv(eventStatsByTeam)], {type: 'text/csv;charset=utf-8'})))
			.attr('download',`${eventId}.scouting.aggregated.csv`)
			.attr('data-source','eventStatsByTeam')
			.click(showDataActions)
		if (!window.analyticsOptOut){
			fetch('https://stats.viperscout.com/collect',{
				method:'POST',
				headers:{'Content-Type': 'application/x-www-form-urlencoded'},
				body: new URLSearchParams({
					pitscouted:Object.keys(pitData).length,
					subjectivescouted:Object.keys(subjectiveData).length,
					scouters:new Set([...eventStats, ...Object.values(subjectiveData), ...Object.values(pitData)].map(x=>(((x.scouter||"")+"").toLowerCase().trim().replace(/\s+/,' '))).filter(x=>x!="")).size,
					scouted:eventStats.length,
					team:window.ourTeam||"",
					viewerteam:localStorage.getItem('my-team')||"",
					host:location.hostname,
					event:eventId
				})
			}).then(response => {
				return response.text()
			}).then(body => {
				body=body.trim()
				if (body!='OK') console.error("Error sending stats: " + body)
			})
		}
		applyTranslations()
		$('#main').show()
	})

	function getScore(eventStatsByTeam, team){
		var stats = eventStatsByTeam[team]
		if (!stats) return 0
		return (stats.score||0)/(stats.count||1)
	}

	function escapeExcelCsvField(s){
		if (Array.isArray(s)) s = s.join(" ")
		if (/[\",\r\n\t]/.test(s)){
			s = '"'+s.replace(/"/g,"")+'"'
		}
		return s
	}

	function excelCsv(dat){
		var csv=Object.keys(statInfo).map(escapeExcelCsvField).join(",")+"\n"
		csv+=Object.keys(statInfo).map(name=>statInfo[name].name).map(escapeExcelCsvField).join(",")+"\n"
		if (!dat.forEach) dat = Object.keys(dat).map(team=>dat[team])
		dat.forEach(row=>{
			csv+=Object.keys(statInfo).map(name=>row[name]!=null?row[name]:"").map(escapeExcelCsvField).join(",")+"\n"
		})
		return csv
	}
	function viewDataAsTable(){
		showLightBox(toTable(window[$(this).attr('data-source')]))
		return false
	}
	function toTable(dat){
		var table = $('<table border=1>')
		toTableRow(table,Object.keys(statInfo),"th")
		toTableRow(table,Object.keys(statInfo).map(name=>statInfo[name].name),"th")
		if (!dat.forEach) dat = Object.keys(dat).map(team=>dat[team])
		dat.forEach(row=>{
			toTableRow(table,Object.keys(statInfo).map(name=>row[name]!=null?row[name]:""),"td")
		})
		var div = $('<div class=lightBoxFullContent style=overflow:auto>').append(table)
		$('body').append(div)
		return div
	}
	function toTableRow(table,dat,cell){
		var tr = $('<tr>')
		dat.forEach(field=>{
			var el = $(`<${cell}>`).text(field)
			el.html(el.html().replace(/_/g,'_<wbr>'))
			tr.append(el)
		})
		table.append(tr)
	}
	$('#showInstructions').click(function(){
		showLightBox($('#instructions'))
	})
	var pitScoutSetupButtonCount=6
	function drawPitScoutSetupButtons(){
		$('#pitScoutSetupButtons').html("")
		for (var i=1; i<=pitScoutSetupButtonCount; i++){
			$('#pitScoutSetupButtons').append($(`<button>${i}</button>`).click(openPitBotScout))
		}
	}
	drawPitScoutSetupButtons()
	$('#pitScoutSetup img').click(function(){
		pitScoutSetupButtonCount+=/up/.test($(this).attr('src'))?1:-1
		if (pitScoutSetupButtonCount < 1) pitScoutSetupButtonCount = 1
		if (pitScoutSetupButtonCount > 10) pitScoutSetupButtonCount = 10
		drawPitScoutSetupButtons()
	})
	function openPitBotScout(){
		promiseEventTeams().then(eventTeams => {
			var squad = parseInt($(this).text())-1
			var perSquad = Math.floor(eventTeams.length/(pitScoutSetupButtonCount)),
			extras = eventTeams.length%(pitScoutSetupButtonCount),
			start = squad*perSquad+Math.min(squad,extras),
			end = start+perSquad+((squad+1>extras)?0:1),
			teamList=eventTeams.slice(start,end).join(",")
			window.open(`/bot-photos.html#event=${eventId}&teams=${teamList}`)
			location.href=(`/${eventYear}/pit-scout.html#event=${eventId}&teams=${teamList}`)
		})
	}
})

var blueAllianceId = eventId
var orangeAllianceId = eventId.replace(/^20([0-9]){2}-([0-9]){2}-(.*)/,"$1$2$3/")
var firstInspiresId = eventId.replace(/^(20[0-9]{2})/,"$1/")

function viewJson(){
	var jv = $('#jsonViewer').html(""),
	lb = $('#jsonLightBox')
	var href=$(this).attr('href')
	lb.find('h2').text(href.replace(/.*\//,""))
	$.getJSON(href, function(json){
		jv.jsonViewer(json, {
			collapsed:false,
			rootCollapsable:false,
			withQuotes:false,
			withLinks:false
		})
	})
	showLightBox(lb)
	return false
}
function showLinks(e){
	var el = $(e.target),
	team,teamName="",pos,
	row=el.closest('tr'),
	match=row.find('.match-id'),
	matchId=match.attr('data-match-id'),
	matchName=match.text(),
	positions="",
	redScore=row.find('.redScore'),
	blueScore=row.find('.blueScore')
	BOT_POSITIONS.forEach(function(pos){
		var t = row.find(`.${pos}`).text()
		if (positions) positions+="&"
		positions += `${pos}=${t}`
	})
	if (/^[0-9]+$/.test(el.text())){
		if (el.attr('class') && /\b[RB][1-3]\b/.test(el.attr('class'))){
			pos=el.attr('class').match(/\b[RB][1-3]\b/)[0]
			team=el.text()
			teamName=el.attr('data-tooltip')
		}
	}
	var html = $('#matchActionsTemplate').html()
		.replace(/_TEAMID_/g, team)
		.replace(/_POS_/g, pos)
		.replace(/_MATCHID_/g, matchId)
		.replace(/_BOTS_/g, positions)
		.replace(/_MATCHNAME_/g, matchName)
		.replace(/_TEAMNAME_/g, teamName)
		.replace(/_REDSCORE_/g, redScore.attr('data-score'))
		.replace(/_BLUESCORE_/g, blueScore.attr('data-score'))
		.replace(/_REDSCOUTED_/g, redScore.attr('data-scouted'))
		.replace(/_BLUESCOUTED_/g, blueScore.attr('data-scouted'))
		.replace(/_REDPREDICTION_/g, redScore.attr('data-prediction'))
		.replace(/_BLUEPREDICTION_/g, blueScore.attr('data-prediction')),
	ma = $('#matchActions')
	ma.html(html).find('.dependTeam').toggle(!!team)
	showLightBox(ma)
}
